<!DOCTYPE html>
<html lang="zh-CN" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>管理控制台 - Sora2API</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @keyframes slide-up{from{transform:translateY(100%);opacity:0}to{transform:translateY(0);opacity:1}}
        .animate-slide-up{animation:slide-up .3s ease-out}
        .tab-btn{transition:all .2s ease}
        details > summary{list-style:none}
        details > summary::-webkit-details-marker{display:none}
    </style>
    <script>
        tailwind.config={theme:{extend:{colors:{border:"hsl(0 0% 89%)",input:"hsl(0 0% 89%)",ring:"hsl(0 0% 3.9%)",background:"hsl(0 0% 100%)",foreground:"hsl(0 0% 3.9%)",primary:{DEFAULT:"hsl(0 0% 9%)",foreground:"hsl(0 0% 98%)"},secondary:{DEFAULT:"hsl(0 0% 96.1%)",foreground:"hsl(0 0% 9%)"},muted:{DEFAULT:"hsl(0 0% 96.1%)",foreground:"hsl(0 0% 45.1%)"},destructive:{DEFAULT:"hsl(0 84.2% 60.2%)",foreground:"hsl(0 0% 98%)"}}}}}
    </script>
</head>
<body class="h-full bg-background text-foreground antialiased">
    <!-- 导航栏 -->
    <header class="sticky top-0 z-50 w-full border-b border-border/40 bg-background/95 backdrop-blur">
        <div class="mx-auto flex h-14 max-w-7xl items-center px-6">
            <div class="mr-4 flex items-baseline gap-3">
                <span class="font-bold text-xl">Sora2API</span>
            </div>
            <div class="flex flex-1 items-center justify-end gap-3">
                <a href="https://github.com/TheSmallHanCat/sora2api" target="_blank" class="inline-flex items-center justify-center text-xs transition-colors hover:bg-accent hover:text-accent-foreground h-7 px-2.5" title="GitHub 仓库">
                    <svg class="h-4 w-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v 3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"/>
                    </svg>
                </a>
                <button onclick="logout()" class="inline-flex items-center justify-center text-xs transition-colors hover:bg-accent hover:text-accent-foreground h-7 px-2.5 gap-1">
                    <svg class="h-3.5 w-3.5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/>
                        <polyline points="16 17 21 12 16 7"/>
                        <line x1="21" y1="12" x2="9" y2="12"/>
                    </svg>
                    退出
                </button>
            </div>
        </div>
    </header>

    <main class="mx-auto max-w-7xl px-6 py-6">
        <!-- Tab 导航 -->
        <div class="border-b border-border mb-6">
            <nav class="flex space-x-8">
                <button onclick="switchTab('tokens')" id="tabTokens" class="tab-btn border-b-2 border-primary text-sm font-medium py-3 px-1">Token 管理</button>
                <button onclick="switchTab('settings')" id="tabSettings" class="tab-btn border-b-2 border-transparent text-sm font-medium py-3 px-1">系统配置</button>
                
                <button onclick="switchTab('logs')" id="tabLogs" class="tab-btn border-b-2 border-transparent text-sm font-medium py-3 px-1">请求日志</button>
            </nav>
        </div>

        <!-- Token 管理面板 -->
        <div id="panelTokens">
            <!-- 统计卡片 -->
            <div class="grid gap-4 grid-cols-2 md:grid-cols-5 mb-6">
                <div class="rounded-lg border border-border bg-background p-4">
                    <p class="text-sm font-medium text-muted-foreground mb-2">Token 总数</p>
                    <h3 class="text-xl font-bold" id="statTotal">-</h3>
                </div>
                <div class="rounded-lg border border-border bg-background p-4">
                    <p class="text-sm font-medium text-muted-foreground mb-2">活跃 Token</p>
                    <h3 class="text-xl font-bold text-green-600" id="statActive">-</h3>
                </div>
                <div class="rounded-lg border border-border bg-background p-4">
                    <p class="text-sm font-medium text-muted-foreground mb-2">今日图片/总图片</p>
                    <h3 class="text-xl font-bold text-blue-600" id="statImages">-</h3>
                </div>
                <div class="rounded-lg border border-border bg-background p-4">
                    <p class="text-sm font-medium text-muted-foreground mb-2">今日视频/总视频</p>
                    <h3 class="text-xl font-bold text-purple-600" id="statVideos">-</h3>
                </div>
                <div class="rounded-lg border border-border bg-background p-4">
                    <p class="text-sm font-medium text-muted-foreground mb-2">今日错误/总错误</p>
                    <h3 class="text-xl font-bold text-destructive" id="statErrors">-</h3>
                </div>
                                            </div>

            <!-- Token 列表 -->
            <div class="rounded-lg border border-border bg-background">
                <div class="flex items-center justify-between gap-4 p-4 border-b border-border">
                    <h3 class="text-lg font-semibold">Token 列表</h3>
                    <div class="flex items-center gap-3">
                        <!-- 状态筛选 -->
                        <select id="tokenStatusFilter" onchange="filterTokens()" class="h-8 rounded-md border border-input bg-background px-2 text-sm">
                            <option value="all">全部状态</option>
                            <option value="active">已启用</option>
                            <option value="inactive">已禁用</option>
                            <option value="sora2">支持Sora2</option>
                            <option value="nosora2">不支持Sora2</option>
                            <option value="expired">已过期</option>
                        </select>
                        <!-- 自动刷新AT标签和开关 -->
                        <div class="flex items-center gap-2">
                            <span class="text-xs text-muted-foreground">自动刷新AT</span>
                            <div class="relative inline-flex items-center group">
                                <label class="inline-flex items-center cursor-pointer">
                                    <input type="checkbox" id="atAutoRefreshToggle" onchange="toggleATAutoRefresh()" class="sr-only peer">
                                    <div class="relative w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-2 peer-focus:ring-primary rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-primary"></div>
                                </label>
                                <!-- 悬浮提示 -->
                                <div class="absolute bottom-full mb-2 left-1/2 transform -translate-x-1/2 bg-gray-900 text-white text-xs rounded px-2 py-1 whitespace-nowrap opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none z-10">
                                    Token距离过期<24h时自动使用ST或RT刷新AT
                                    <div class="absolute top-full left-1/2 transform -translate-x-1/2 border-4 border-transparent border-t-gray-900"></div>
                                </div>
                            </div>
                        </div>
                        <button onclick="refreshTokens()" class="inline-flex items-center justify-center rounded-md transition-colors hover:bg-accent h-8 w-8" title="刷新">
                            <svg class="h-4 w-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <polyline points="23 4 23 10 17 10"/><polyline points="1 20 1 14 7 14"/><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"/>
                            </svg>
                        </button>
                        <button onclick="exportTokens()" class="inline-flex items-center justify-center rounded-md bg-blue-600 text-white hover:bg-blue-700 h-8 px-3" title="导出所有Token">
                            <svg class="h-4 w-4 mr-2" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                                <polyline points="7 10 12 15 17 10"/>
                                <line x1="12" y1="15" x2="12" y2="3"/>
                            </svg>
                            <span class="text-sm font-medium">导出</span>
                        </button>
                        <button onclick="openImportModal()" class="inline-flex items-center justify-center rounded-md bg-green-600 text-white hover:bg-green-700 h-8 px-3" title="导入Token">
                            <svg class="h-4 w-4 mr-2" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                                <polyline points="17 8 12 3 7 8"/>
                                <line x1="12" y1="3" x2="12" y2="15"/>
                            </svg>
                            <span class="text-sm font-medium">导入</span>
                        </button>
                        <button onclick="openAddModal()" class="inline-flex items-center justify-center rounded-md bg-primary text-primary-foreground hover:bg-primary/90 h-8 px-3">
                            <svg class="h-4 w-4 mr-2" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <line x1="12" y1="5" x2="12" y2="19"/>
                                <line x1="5" y1="12" x2="19" y2="12"/>
                            </svg>
                            <span class="text-sm font-medium">新增</span>
                        </button>
                        <!-- 批量测试下拉菜单 -->
                        <div class="relative inline-block">
                            <button onclick="toggleBatchTestMenu()" class="inline-flex items-center justify-center rounded-md bg-cyan-600 text-white hover:bg-cyan-700 h-8 px-3" title="批量操作">
                                <svg class="h-4 w-4 mr-2" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M9 11l3 3L22 4"/>
                                    <path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"/>
                                </svg>
                                <span class="text-sm font-medium">批量操作</span>
                                <svg class="h-4 w-4 ml-1" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <polyline points="6 9 12 15 18 9"/>
                                </svg>
                            </button>
                            <div id="batchTestMenu" class="hidden absolute right-0 mt-1 w-48 rounded-md shadow-lg bg-white border border-border z-50">
                                <div class="py-1">
                                    <button onclick="openBatchAddModal();$('batchTestMenu').classList.add('hidden')" class="w-full text-left px-4 py-2 text-sm hover:bg-gray-100 text-purple-600">
                                        批量新增
                                        <p class="text-xs text-muted-foreground">批量添加多个Token</p>
                                    </button>
                                    <button onclick="batchActivateUsernames()" class="w-full text-left px-4 py-2 text-sm hover:bg-gray-100 text-orange-600">
                                        一键激活用户名
                                        <p class="text-xs text-muted-foreground">为所有活跃Token激活用户名</p>
                                    </button>
                                    <hr class="my-1 border-border">
                                    <button onclick="batchTestActiveTokens()" class="w-full text-left px-4 py-2 text-sm hover:bg-gray-100">
                                        测试已启用账号
                                        <p class="text-xs text-muted-foreground">401自动禁用</p>
                                    </button>
                                    <button onclick="batchTestDisabledTokens()" class="w-full text-left px-4 py-2 text-sm hover:bg-gray-100">
                                        测试已禁用账号
                                        <p class="text-xs text-muted-foreground">有效自动启用</p>
                                    </button>
                                    <button onclick="batchTestAllTokens()" class="w-full text-left px-4 py-2 text-sm hover:bg-gray-100">
                                        测试所有账号
                                        <p class="text-xs text-muted-foreground">自动禁用/启用</p>
                                    </button>
                                    <hr class="my-1 border-border">
                                    <button onclick="batchEnableAllTokens()" class="w-full text-left px-4 py-2 text-sm hover:bg-gray-100 text-green-600">
                                        一键启用所有
                                        <p class="text-xs text-muted-foreground">启用所有禁用账号</p>
                                    </button>
                                    <button onclick="batchDisableAllTokens()" class="w-full text-left px-4 py-2 text-sm hover:bg-gray-100 text-red-600">
                                        一键禁用所有
                                        <p class="text-xs text-muted-foreground">禁用所有启用账号</p>
                                    </button>
                                    <button onclick="batchDeleteDisabledTokens()" class="w-full text-left px-4 py-2 text-sm hover:bg-gray-100 text-red-600">
                                        一键删除禁用
                                        <p class="text-xs text-muted-foreground">删除所有禁用账号</p>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="relative w-full">
                    <table class="w-full text-sm table-fixed">
                        <thead>
                            <tr class="border-b border-border">
                                <th class="h-10 px-3 text-left align-middle font-medium text-muted-foreground w-[38%]">账号</th>
                                <th class="h-10 px-3 text-left align-middle font-medium text-muted-foreground w-[27%]">授权 / 时效</th>
                                <th class="h-10 px-3 text-center align-middle font-medium text-muted-foreground w-[20%]">统计</th>
                                <th class="h-10 px-3 text-center align-middle font-medium text-muted-foreground w-[15%]">操作</th>
                            </tr>
                        </thead>
                        <tbody id="tokenTableBody" class="divide-y divide-border">
                            <!-- 动态填充 -->
                        </tbody>
                    </table>
                </div>
                
                <!-- 分页控件 -->
                <div id="tokenPagination" class="flex items-center justify-between p-4 border-t border-border">
                    <div class="text-sm text-muted-foreground">
                        显示 <span id="pageStart">0</span>-<span id="pageEnd">0</span> 共 <span id="totalTokens">0</span> 个
                    </div>
                    <div class="flex items-center gap-2">
                        <select id="pageSize" onchange="changePageSize()" class="h-8 rounded-md border border-input bg-background px-2 text-sm">
                            <option value="10">10条/页</option>
                            <option value="20" selected>20条/页</option>
                            <option value="50">50条/页</option>
                            <option value="100">100条/页</option>
                        </select>
                        <button onclick="prevPage()" id="prevPageBtn" class="inline-flex items-center justify-center rounded-md border border-input bg-background hover:bg-accent h-8 px-3 text-sm disabled:opacity-50" disabled>上一页</button>
                        <span class="text-sm">第 <span id="currentPage">1</span> / <span id="totalPages">1</span> 页</span>
                        <button onclick="nextPage()" id="nextPageBtn" class="inline-flex items-center justify-center rounded-md border border-input bg-background hover:bg-accent h-8 px-3 text-sm disabled:opacity-50" disabled>下一页</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- 系统配置面板 -->
        <div id="panelSettings" class="hidden">
            <div class="grid gap-6 lg:grid-cols-2">
                <!-- 安全配置 -->
                <div class="rounded-lg border border-border bg-background p-6">
                    <div class="flex items-start justify-between mb-4">
                        <div>
                            <h3 class="text-base font-semibold">安全配置</h3>
                            <p class="text-xs text-muted-foreground mt-1">管理员账户与密码设置</p>
                        </div>
                    </div>
                    <div class="space-y-4">
                        <div>
                            <label class="text-sm font-medium mb-2 block">管理员用户名</label>
                            <input id="cfgAdminUsername" type="text" class="flex h-9 w-full rounded-md border border-input bg-background px-3 py-2 text-sm">
                            <p class="text-xs text-muted-foreground mt-1">用于后台登录</p>
                        </div>
                        <div class="grid gap-4 sm:grid-cols-2">
                            <div>
                                <label class="text-sm font-medium mb-2 block">旧密码</label>
                                <input id="cfgOldPassword" type="password" class="flex h-9 w-full rounded-md border border-input bg-background px-3 py-2 text-sm" placeholder="输入旧密码">
                            </div>
                            <div>
                                <label class="text-sm font-medium mb-2 block">新密码</label>
                                <input id="cfgNewPassword" type="password" class="flex h-9 w-full rounded-md border border-input bg-background px-3 py-2 text-sm" placeholder="输入新密码">
                            </div>
                        </div>
                    </div>
                    <div class="flex justify-end pt-4">
                        <button onclick="updateAdminPassword()" class="inline-flex items-center justify-center rounded-md bg-primary text-primary-foreground hover:bg-primary/90 h-9 px-4">修改密码</button>
                    </div>
                </div>

                <!-- API 密钥配置 -->
                <div class="rounded-lg border border-border bg-background p-6">
                    <div class="flex items-start justify-between mb-4">
                        <div>
                            <h3 class="text-base font-semibold">API 密钥配置</h3>
                            <p class="text-xs text-muted-foreground mt-1">客户端调用所需的鉴权密钥</p>
                        </div>
                    </div>
                    <div class="space-y-4">
                        <div>
                            <label class="text-sm font-medium mb-2 block">当前 API Key</label>
                            <input id="cfgCurrentAPIKey" type="text" class="flex h-9 w-full rounded-md border border-input bg-muted/40 px-3 py-2 text-sm" readonly disabled>
                            <p class="text-xs text-muted-foreground mt-1">只读展示</p>
                        </div>
                        <div>
                            <label class="text-sm font-medium mb-2 block">新 API Key</label>
                            <input id="cfgNewAPIKey" type="text" class="flex h-9 w-full rounded-md border border-input bg-background px-3 py-2 text-sm" placeholder="输入新的 API Key">
                            <p class="text-xs text-muted-foreground mt-1">更新后需通知客户端替换密钥</p>
                        </div>
                    </div>
                    <div class="flex justify-end pt-4">
                        <button onclick="updateAPIKey()" class="inline-flex items-center justify-center rounded-md bg-primary text-primary-foreground hover:bg-primary/90 h-9 px-4">更新 API Key</button>
                    </div>
                </div>

                <!-- 代理配置 -->
                <div class="rounded-lg border border-border bg-background p-6">
                    <div class="flex items-start justify-between mb-4">
                        <div>
                            <h3 class="text-base font-semibold">代理配置</h3>
                            <p class="text-xs text-muted-foreground mt-1">全局代理与代理池轮询设置</p>
                        </div>
                    </div>
                    <div class="space-y-4">
                        <div class="rounded-md border border-border/60 bg-muted/20 p-3">
                            <label class="inline-flex items-center gap-2 cursor-pointer">
                                <input type="checkbox" id="cfgProxyEnabled" class="h-4 w-4 rounded border-input">
                                <span class="text-sm font-medium">启用代理</span>
                            </label>
                            <p class="text-xs text-muted-foreground mt-1">开启后请求将走代理</p>
                        </div>
                        <div>
                            <label class="text-sm font-medium mb-2 block">代理地址</label>
                            <input id="cfgProxyUrl" class="flex h-9 w-full rounded-md border border-input bg-background px-3 py-2 text-sm" placeholder="http://127.0.0.1:7890 或 socks5://127.0.0.1:1080">
                            <p class="text-xs text-muted-foreground mt-1">支持 HTTP/SOCKS5</p>
                        </div>
                        <div class="rounded-md border border-border/60 bg-muted/20 p-3">
                            <label class="inline-flex items-center gap-2 cursor-pointer">
                                <input type="checkbox" id="cfgProxyPoolEnabled" class="h-4 w-4 rounded border-input">
                                <span class="text-sm font-medium">轮询代理池</span>
                            </label>
                            <p class="text-xs text-muted-foreground mt-1">从 data/proxy.txt 读取代理列表</p>
                            <p id="proxyPoolCount" class="text-xs text-blue-600 mt-1 hidden">当前代理池数量: <span id="proxyPoolCountValue">0</span></p>
                        </div>
                    </div>
                    <div class="flex justify-end pt-4">
                        <button onclick="saveProxyConfig()" class="inline-flex items-center justify-center rounded-md bg-primary text-primary-foreground hover:bg-primary/90 h-9 px-4">保存配置</button>
                    </div>
                </div>

                <!-- 代理池管理 -->
                <div class="rounded-lg border border-border bg-background p-6">
                    <div class="flex items-start justify-between mb-4">
                        <div>
                            <h3 class="text-base font-semibold">代理池管理</h3>
                            <p class="text-xs text-muted-foreground mt-1">维护 data/proxy.txt 并批量检测可用性</p>
                        </div>
                    </div>
                    <div class="space-y-4">
                        <div>
                            <label class="text-sm font-medium mb-2 block">代理列表 (data/proxy.txt)</label>
                            <textarea id="cfgProxyPool" rows="8" class="flex w-full rounded-md border border-input bg-background px-3 py-2 text-sm font-mono resize-y" placeholder="# 每行一个代理地址&#10;http://host:port&#10;socks5://host:port&#10;http://user:pass@host:port&#10;st5 host:port:user:pass"></textarea>
                            <p class="text-xs text-muted-foreground mt-1">每行一个代理，以 # 开头的行为注释，检测目标: sora.chatgpt.com</p>
                        </div>
                        <div class="flex gap-2">
                            <button onclick="loadProxyPool()" class="inline-flex items-center justify-center rounded-md border border-input bg-background hover:bg-accent h-9 px-4 flex-1">
                                <svg class="h-4 w-4 mr-2" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <polyline points="23 4 23 10 17 10"/><polyline points="1 20 1 14 7 14"/><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"/>
                                </svg>
                                刷新
                            </button>
                            <button onclick="saveProxyPool()" class="inline-flex items-center justify-center rounded-md bg-primary text-primary-foreground hover:bg-primary/90 h-9 px-4 flex-1">保存代理池</button>
                        </div>
                        <div class="flex gap-2 pt-2 border-t border-border">
                            <button onclick="testAllProxies(false)" class="inline-flex items-center justify-center rounded-md bg-emerald-600 text-white hover:bg-emerald-700 h-9 px-4 flex-1">
                                <svg class="h-4 w-4 mr-2" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/>
                                    <polyline points="22 4 12 14.01 9 11.01"/>
                                </svg>
                                检测全部代理
                            </button>
                            <button onclick="testAllProxies(true)" class="inline-flex items-center justify-center rounded-md bg-amber-600 text-white hover:bg-amber-700 h-9 px-4 flex-1">
                                <svg class="h-4 w-4 mr-2" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
                                </svg>
                                检测并剔除无效
                            </button>
                        </div>
                        <div id="proxyTestResults" class="hidden space-y-3 pt-3 border-t border-border">
                            <div class="grid grid-cols-4 gap-2 text-center">
                                <div class="p-2 rounded-md border border-border/60 bg-muted/20">
                                    <p class="text-xs text-muted-foreground">总数</p>
                                    <p class="text-lg font-semibold" id="proxyTestTotal">0</p>
                                </div>
                                <div class="p-2 rounded-md border border-emerald-200 bg-emerald-50">
                                    <p class="text-xs text-emerald-700">有效</p>
                                    <p class="text-lg font-semibold text-emerald-700" id="proxyTestValid">0</p>
                                </div>
                                <div class="p-2 rounded-md border border-rose-200 bg-rose-50">
                                    <p class="text-xs text-rose-600">无效</p>
                                    <p class="text-lg font-semibold text-rose-600" id="proxyTestInvalid">0</p>
                                </div>
                                <div class="p-2 rounded-md border border-amber-200 bg-amber-50">
                                    <p class="text-xs text-amber-700">已剔除</p>
                                    <p class="text-lg font-semibold text-amber-700" id="proxyTestRemoved">0</p>
                                </div>
                            </div>
                            <div id="proxyTestList" class="max-h-40 overflow-y-auto space-y-1 rounded-md border border-border/60 bg-muted/10 p-2 text-xs"></div>
                        </div>
                    </div>
                </div>

                <!-- 错误处理配置 -->
                <div class="rounded-lg border border-border bg-background p-6">
                    <div class="flex items-start justify-between mb-4">
                        <div>
                            <h3 class="text-base font-semibold">错误处理配置</h3>
                            <p class="text-xs text-muted-foreground mt-1">控制 Token 自动禁用的阈值策略</p>
                        </div>
                    </div>
                    <div class="space-y-4">
                        <div>
                            <label class="text-sm font-medium mb-2 block">错误封禁阈值</label>
                            <input id="cfgErrorBan" type="number" class="flex h-9 w-full rounded-md border border-input bg-background px-3 py-2 text-sm" placeholder="3">
                            <p class="text-xs text-muted-foreground mt-1">Token 连续错误达到此次数后自动禁用</p>
                        </div>
                    </div>
                    <div class="flex justify-end pt-4">
                        <button onclick="saveAdminConfig()" class="inline-flex items-center justify-center rounded-md bg-primary text-primary-foreground hover:bg-primary/90 h-9 px-4">保存配置</button>
                    </div>
                </div>

                <!-- 缓存配置 -->
                <div class="rounded-lg border border-border bg-background p-6">
                    <div class="flex items-start justify-between mb-4">
                        <div>
                            <h3 class="text-base font-semibold">缓存配置</h3>
                            <p class="text-xs text-muted-foreground mt-1">控制缓存开关与访问域名</p>
                        </div>
                    </div>
                    <div class="space-y-4">
                        <div class="rounded-md border border-border/60 bg-muted/20 p-3">
                            <label class="inline-flex items-center gap-2 cursor-pointer">
                                <input type="checkbox" id="cfgCacheEnabled" class="h-4 w-4 rounded border-input" onchange="toggleCacheOptions()">
                                <span class="text-sm font-medium">启用缓存</span>
                            </label>
                            <p class="text-xs text-muted-foreground mt-1">关闭后，生成的图片和视频将直接输出原始链接，不会缓存到本地</p>
                        </div>

                        <!-- 缓存配置选项 -->
                        <div id="cacheOptions" style="display: none;" class="space-y-4">
                            <div class="rounded-md border border-border/60 bg-muted/20 p-3 space-y-4">
                                <div>
                                    <label class="text-sm font-medium mb-2 block">缓存超时时间（秒）</label>
                                    <input id="cfgCacheTimeout" type="number" class="flex h-9 w-full rounded-md border border-input bg-background px-3 py-2 text-sm" placeholder="7200" min="60" max="86400">
                                    <p class="text-xs text-muted-foreground mt-1">文件缓存超时时间，范围：60-86400 秒（1分钟-24小时）</p>
                                </div>
                                <div>
                                    <label class="text-sm font-medium mb-2 block">缓存文件访问域名</label>
                                    <input id="cfgCacheBaseUrl" type="text" class="flex h-9 w-full rounded-md border border-input bg-background px-3 py-2 text-sm" placeholder="https://yourdomain.com">
                                    <p class="text-xs text-muted-foreground mt-1">留空则使用服务器地址，例如：https://yourdomain.com</p>
                                </div>
                                <div id="cacheEffectiveUrl" class="rounded-md border border-border/60 bg-background p-2 hidden">
                                    <p class="text-xs text-muted-foreground">
                                        <strong>当前生效的访问地址：</strong><code id="cacheEffectiveUrlValue" class="bg-muted px-1 py-0.5 rounded"></code>
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="flex justify-end pt-4">
                        <button onclick="saveCacheConfig()" class="inline-flex items-center justify-center rounded-md bg-primary text-primary-foreground hover:bg-primary/90 h-9 px-4">保存配置</button>
                    </div>
                </div>

                <!-- 生成超时配置 -->
                <div class="rounded-lg border border-border bg-background p-6">
                    <div class="flex items-start justify-between mb-4">
                        <div>
                            <h3 class="text-base font-semibold">生成超时配置</h3>
                            <p class="text-xs text-muted-foreground mt-1">设置图片与视频的超时阈值</p>
                        </div>
                    </div>
                    <div class="space-y-4">
                        <div class="grid gap-4 sm:grid-cols-2">
                            <div>
                                <label class="text-sm font-medium mb-2 block">图片生成超时时间（秒）</label>
                                <input id="cfgImageTimeout" type="number" class="flex h-9 w-full rounded-md border border-input bg-background px-3 py-2 text-sm" placeholder="300" min="60" max="3600">
                                <p class="text-xs text-muted-foreground mt-1">范围：60-3600 秒（1分钟-1小时），超时后自动释放 Token 锁</p>
                            </div>
                            <div>
                                <label class="text-sm font-medium mb-2 block">视频生成超时时间（秒）</label>
                                <input id="cfgVideoTimeout" type="number" class="flex h-9 w-full rounded-md border border-input bg-background px-3 py-2 text-sm" placeholder="1500" min="60" max="7200">
                                <p class="text-xs text-muted-foreground mt-1">范围：60-7200 秒（1分钟-2小时），超时后返回上游 API 超时错误</p>
                            </div>
                        </div>
                    </div>
                    <div class="flex justify-end pt-4">
                        <button onclick="saveGenerationTimeout()" class="inline-flex items-center justify-center rounded-md bg-primary text-primary-foreground hover:bg-primary/90 h-9 px-4">保存配置</button>
                    </div>
                </div>

                <!-- Lambda 创建配置 -->
                <div class="rounded-lg border border-border bg-background p-6">
                    <div class="flex items-start justify-between mb-4">
                        <div>
                            <h3 class="text-base font-semibold">Lambda 创建配置</h3>
                            <p class="text-xs text-muted-foreground mt-1">启用后 /v1/videos 通过 Lambda 创建任务，仅用于创建（进度仍由本项目拉取）</p>
                        </div>
                    </div>
                    <div class="space-y-4">
                        <div class="rounded-md border border-border/60 bg-muted/20 p-3">
                            <label class="inline-flex items-center gap-2 cursor-pointer">
                                <input type="checkbox" id="cfgLambdaEnabled" class="h-4 w-4 rounded border-input" onchange="toggleLambdaOptions()">
                                <span class="text-sm font-medium">启用 Lambda 创建</span>
                            </label>
                            <p class="text-xs text-muted-foreground mt-2">仅转发创建请求，任务进度与结果仍由本服务查询</p>
                        </div>
                        <div id="lambdaOptions" style="display: none;" class="space-y-4">
                            <div class="rounded-md border border-border/60 bg-muted/20 p-3 space-y-4">
                                <div>
                                    <label class="text-sm font-medium mb-2 block">Lambda 终端地址（支持多个URL轮询）</label>
                                    <div id="lambdaUrlsContainer" class="space-y-2">
                                        <!-- URL输入框将在这里动态生成 -->
                                    </div>
                                    <button type="button" onclick="addLambdaUrl()" class="inline-flex items-center justify-center text-xs transition-colors hover:bg-accent hover:text-accent-foreground h-7 px-2.5 gap-1 border border-input rounded-md">
                                        <svg class="h-3 w-3" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <line x1="12" y1="5" x2="12" y2="19"/>
                                            <line x1="5" y1="12" x2="19" y2="12"/>
                                        </svg>
                                        添加URL
                                    </button>
                                    <p class="text-xs text-muted-foreground mt-1">支持多个Lambda终端地址，系统将自动轮询使用。必须是可访问的 HTTP/HTTPS 地址</p>
                                </div>
                                <div>
                                    <label class="text-sm font-medium mb-2 block">Lambda 访问密钥</label>
                                    <input id="cfgLambdaApiKey" type="password" class="flex h-9 w-full rounded-md border border-input bg-background px-3 py-2 text-sm" placeholder="用于校验 x-lambda-key">
                                    <p class="text-xs text-muted-foreground mt-1">对应 Lambda 的 LAMBDA_SHARED_KEY，所有URL使用相同的密钥</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="flex justify-end pt-4">
                        <button onclick="saveLambdaConfig()" class="inline-flex items-center justify-center rounded-md bg-primary text-primary-foreground hover:bg-primary/90 h-9 px-4">保存配置</button>
                    </div>
                </div>

                <!-- 无水印模式配置 -->
                <div class="rounded-lg border border-border bg-background p-6">
                    <div class="flex items-start justify-between mb-4">
                        <div>
                            <h3 class="text-base font-semibold">无水印模式配置</h3>
                            <p class="text-xs text-muted-foreground mt-1">控制发布后解析与清理流程</p>
                        </div>
                    </div>
                    <div class="space-y-4">
                        <div class="rounded-md border border-border/60 bg-muted/20 p-3">
                            <label class="inline-flex items-center gap-2 cursor-pointer">
                                <input type="checkbox" id="cfgWatermarkFreeEnabled" class="h-4 w-4 rounded border-input" onchange="toggleWatermarkFreeOptions()">
                                <span class="text-sm font-medium">开启无水印模式</span>
                            </label>
                            <p class="text-xs text-muted-foreground mt-2">开启后生成的视频将会被发布到 sora 平台并提取无水印视频，缓存到本地后自动删除发布的视频</p>
                        </div>

                        <!-- 解析方式选择 -->
                        <div id="watermarkFreeOptions" style="display: none;" class="space-y-4">
                            <div class="rounded-md border border-border/60 bg-muted/20 p-3 space-y-4">
                                <div>
                                    <label class="text-sm font-medium">解析方式</label>
                                    <select id="cfgParseMethod" class="w-full mt-2 px-3 py-2 border border-input rounded-md bg-background text-foreground" onchange="toggleCustomParseOptions()">
                                        <option value="third_party">第三方解析</option>
                                        <option value="custom">自定义解析接口</option>
                                    </select>
                                </div>

                                <!-- 自定义解析配置 -->
                                <div id="customParseOptions" style="display: none;" class="space-y-4">
                                    <div>
                                        <label class="text-sm font-medium">解析服务器地址</label>
                                        <input type="text" id="cfgCustomParseUrl" placeholder="请输入解析服务器地址 (例如: http://example.com)" class="w-full mt-2 px-3 py-2 border border-input rounded-md bg-background text-foreground">
                                        <p class="text-xs text-muted-foreground mt-1"><a href="https://github.com/tibbar213/sora-downloader" target="_blank" class="text-blue-600 hover:text-blue-800 underline">部署自定义解析服务器</a></p>
                                    </div>
                                    <div>
                                        <label class="text-sm font-medium">访问密钥</label>
                                        <input type="password" id="cfgCustomParseToken" placeholder="请输入访问密钥" class="w-full mt-2 px-3 py-2 border border-input rounded-md bg-background text-foreground">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="flex justify-end pt-4">
                        <button onclick="saveWatermarkFreeConfig()" class="inline-flex items-center justify-center rounded-md bg-primary text-primary-foreground hover:bg-primary/90 h-9 px-4">保存配置</button>
                    </div>
                </div>

                <!-- 调试配置 -->
                <div class="rounded-lg border border-border bg-background p-6">
                    <div class="flex items-start justify-between mb-4">
                        <div>
                            <h3 class="text-base font-semibold">调试配置</h3>
                            <p class="text-xs text-muted-foreground mt-1">控制详细日志与调试输出</p>
                        </div>
                    </div>
                    <div class="space-y-4">
                        <div class="rounded-md border border-border/60 bg-muted/20 p-3">
                            <label class="inline-flex items-center gap-2 cursor-pointer">
                                <input type="checkbox" id="cfgDebugEnabled" class="h-4 w-4 rounded border-input" onchange="toggleDebugMode()">
                                <span class="text-sm font-medium">启用调试模式</span>
                            </label>
                            <p class="text-xs text-muted-foreground mt-2">开启后，详细的上游 API 请求和响应日志将写入 <code class="bg-muted px-1 py-0.5 rounded">logs.txt</code> 文件，重启生效</p>
                        </div>
                        <div class="rounded-md border border-amber-200 bg-amber-50 p-3">
                            <p class="text-xs text-amber-900">
                                <strong>注意：</strong>调试模式会产生大量日志，仅限 Debug 时开启
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 请求日志面板 -->
        <div id="panelLogs" class="hidden">
            <div class="rounded-lg border border-border bg-background">
                <div class="flex items-center justify-between gap-4 p-4 border-b border-border">
                    <div>
                        <h3 class="text-lg font-semibold">请求日志</h3>
                        <p class="text-xs text-muted-foreground mt-1">最近 100 条请求，展示任务状态与进度</p>
                    </div>
                    <button onclick="refreshLogs()" class="inline-flex items-center justify-center rounded-md transition-colors hover:bg-accent h-8 w-8" title="刷新">
                        <svg class="h-4 w-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <polyline points="23 4 23 10 17 10"/><polyline points="1 20 1 14 7 14"/><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"/>
                        </svg>
                    </button>
                </div>
                <div class="relative w-full overflow-auto max-h-[620px]">
                    <table class="w-full text-sm">
                        <thead class="sticky top-0 bg-background/95 backdrop-blur">
                            <tr class="border-b border-border">
                                <th class="h-10 px-3 text-left align-middle font-medium text-muted-foreground">操作 / 任务</th>
                                <th class="h-10 px-3 text-left align-middle font-medium text-muted-foreground">Token</th>
                                <th class="h-10 px-3 text-left align-middle font-medium text-muted-foreground">状态</th>
                                <th class="h-10 px-3 text-left align-middle font-medium text-muted-foreground">进度</th>
                                <th class="h-10 px-3 text-left align-middle font-medium text-muted-foreground">耗时</th>
                                <th class="h-10 px-3 text-left align-middle font-medium text-muted-foreground">时间</th>
                                <th class="h-10 px-3 text-right align-middle font-medium text-muted-foreground">详情</th>
                            </tr>
                        </thead>
                        <tbody id="logsTableBody" class="divide-y divide-border">
                            <!-- 动态填充 -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- 页脚 -->
        <footer class="mt-12 pt-6 border-t border-border text-center text-xs text-muted-foreground">
            <p>© 2025 <a href="https://linux.do/u/thesmallhancat/summary" target="_blank" class="no-underline hover:underline" style="color: inherit;">TheSmallHanCat</a> && <a href="https://linux.do/u/tibbar/summary" target="_blank" class="no-underline hover:underline" style="color: inherit;">Tibbar</a>. All rights reserved.</p>
        </footer>
    </main>

    <!-- 日志详情模态框 -->
    <div id="logDetailModal" class="hidden fixed inset-0 z-50 bg-black/80 flex items-center justify-center p-4 overflow-y-auto">
        <div class="bg-background rounded-lg border border-border w-full max-w-2xl shadow-xl my-auto">
            <div class="flex items-center justify-between p-5 border-b border-border sticky top-0 bg-background">
                <h3 class="text-lg font-semibold">日志详情</h3>
                <button onclick="closeLogDetailModal()" class="rounded-md hover:bg-accent p-1">
                    <svg class="h-5 w-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/>
                    </svg>
                </button>
            </div>
            <div id="logDetailContent" class="p-5 max-h-[70vh] overflow-y-auto">
            </div>
        </div>
    </div>

    <!-- 添加 Token 模态框 -->
    <div id="addModal" class="hidden fixed inset-0 z-50 bg-black/80 flex items-center justify-center p-4 overflow-y-auto">
        <div class="bg-background rounded-lg border border-border w-full max-w-2xl shadow-xl my-auto">
            <div class="flex items-center justify-between p-5 border-b border-border sticky top-0 bg-background">
                <h3 class="text-lg font-semibold">添加 Token</h3>
                <button onclick="closeAddModal()" class="text-muted-foreground hover:text-foreground">
                    <svg class="h-3.5 w-3.5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="18" y1="6" x2="6" y2="18"/>
                        <line x1="6" y1="6" x2="18" y2="18"/>
                    </svg>
                </button>
            </div>
            <div class="p-5 space-y-5 max-h-[calc(100vh-200px)] overflow-y-auto">
                <div class="rounded-md border border-border/60 bg-background p-4 space-y-4">
                    <p class="text-sm font-semibold">认证凭据</p>
                    <div class="space-y-2">
                        <label class="text-sm font-medium">Access Token (AT) <span class="text-red-500">*</span></label>
                        <textarea id="addTokenAT" rows="3" class="flex w-full rounded-md border border-input bg-background px-3 py-2 text-sm font-mono resize-none" placeholder="请输入 Access Token 或使用下方 ST/RT 转换"></textarea>
                        <p class="text-xs text-muted-foreground">格式: eyJh... (JWT格式)</p>
                    </div>
                    <div class="grid gap-4 sm:grid-cols-2">
                        <div class="space-y-2">
                            <label class="text-sm font-medium">Session Token (ST) <span class="text-muted-foreground text-xs">- 可选</span></label>
                            <div class="flex gap-2">
                                <textarea id="addTokenST" rows="2" class="flex w-full rounded-md border border-input bg-background px-3 py-2 text-sm font-mono resize-none" placeholder="输入 Session Token 后点击转换"></textarea>
                                <button onclick="convertST2AT()" class="inline-flex items-center justify-center rounded-md bg-blue-600 text-white hover:bg-blue-700 px-4 whitespace-nowrap h-9">ST→AT</button>
                            </div>
                            <p class="text-xs text-muted-foreground">从浏览器 Cookie 中获取 __Secure-next-auth.session-token</p>
                        </div>
                        <div class="space-y-2">
                            <label class="text-sm font-medium">Refresh Token (RT) <span class="text-muted-foreground text-xs">- 可选</span></label>
                            <div class="flex gap-2">
                                <textarea id="addTokenRT" rows="2" class="flex w-full rounded-md border border-input bg-background px-3 py-2 text-sm font-mono resize-none" placeholder="输入 Refresh Token 后点击转换"></textarea>
                                <button onclick="convertRT2AT()" class="inline-flex items-center justify-center rounded-md bg-green-600 text-white hover:bg-green-700 px-4 whitespace-nowrap h-9">RT→AT</button>
                            </div>
                            <p class="text-xs text-muted-foreground">从移动端或其他客户端获取</p>
                            <p id="addRTRefreshHint" class="text-xs text-green-600 font-medium hidden">✓ RT已被刷新，已填入更新后的RT</p>
                        </div>
                    </div>
                </div>

                <div class="rounded-md border border-border/60 bg-background p-4 space-y-4">
                    <p class="text-sm font-semibold">可选配置</p>
                    <div class="grid gap-4 sm:grid-cols-2">
                        <div class="space-y-2">
                            <label class="text-sm font-medium">Client ID <span class="text-muted-foreground text-xs">- 可选</span></label>
                            <input id="addTokenClientId" class="flex h-9 w-full rounded-md border border-input bg-background px-3 py-2 text-sm font-mono" placeholder="留空使用默认值">
                            <p class="text-xs text-muted-foreground">用于 RT 刷新，留空使用默认 Client ID</p>
                        </div>
                        <div class="space-y-2">
                            <label class="text-sm font-medium">代理 <span class="text-muted-foreground text-xs">- 可选</span></label>
                            <input id="addTokenProxyUrl" class="flex h-9 w-full rounded-md border border-input bg-background px-3 py-2 text-sm font-mono" placeholder="http://127.0.0.1:7890 或 socks5://127.0.0.1:1080">
                            <p class="text-xs text-muted-foreground">支持 http 和 socks5 代理，留空使用系统设置的代理</p>
                        </div>
                        <div class="space-y-2 sm:col-span-2">
                            <label class="text-sm font-medium">备注 <span class="text-muted-foreground text-xs">- 可选</span></label>
                            <input id="addTokenRemark" class="flex h-9 w-full rounded-md border border-input bg-background px-3 py-2 text-sm" placeholder="添加备注信息">
                        </div>
                    </div>
                </div>

                <div class="rounded-md border border-border/60 bg-background p-4 space-y-3">
                    <p class="text-sm font-semibold">功能开关</p>
                    <div class="grid gap-3 sm:grid-cols-2">
                        <div class="flex items-center justify-between gap-3 rounded-md border border-border/60 bg-background px-3 py-2">
                            <label class="inline-flex items-center gap-2 cursor-pointer">
                                <input type="checkbox" id="addTokenImageEnabled" checked class="h-4 w-4 rounded border-input">
                                <span class="text-sm font-medium">启用图片生成</span>
                            </label>
                            <input type="number" id="addTokenImageConcurrency" value="-1" class="flex h-8 w-20 rounded-md border border-input bg-background px-2 py-1 text-sm" placeholder="并发数" title="并发数量限制：设置同时处理的最大请求数。-1表示不限制">
                        </div>
                        <div class="flex items-center justify-between gap-3 rounded-md border border-border/60 bg-background px-3 py-2">
                            <label class="inline-flex items-center gap-2 cursor-pointer">
                                <input type="checkbox" id="addTokenVideoEnabled" checked class="h-4 w-4 rounded border-input">
                                <span class="text-sm font-medium">启用视频生成</span>
                            </label>
                            <input type="number" id="addTokenVideoConcurrency" value="-1" class="flex h-8 w-20 rounded-md border border-input bg-background px-2 py-1 text-sm" placeholder="并发数" title="并发数量限制：设置同时处理的最大请求数。-1表示不限制">
                        </div>
                    </div>
                    <p class="text-xs text-muted-foreground">并发数：-1 表示不限制</p>
                </div>
            </div>
            <div class="flex items-center justify-end gap-3 p-5 border-t border-border sticky bottom-0 bg-background">
                <button onclick="closeAddModal()" class="inline-flex items-center justify-center rounded-md border border-input bg-background hover:bg-accent h-9 px-5">取消</button>
                <button id="addTokenBtn" onclick="submitAddToken()" class="inline-flex items-center justify-center rounded-md bg-primary text-primary-foreground hover:bg-primary/90 h-9 px-5">
                    <span id="addTokenBtnText">添加</span>
                    <svg id="addTokenBtnSpinner" class="hidden animate-spin h-4 w-4 ml-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                </button>
            </div>
        </div>
    </div>

    <!-- 编辑 Token 模态框 -->
    <div id="editModal" class="hidden fixed inset-0 z-50 bg-black/80 flex items-center justify-center p-4 overflow-y-auto">
        <div class="bg-background rounded-lg border border-border w-full max-w-2xl shadow-xl my-auto">
            <div class="flex items-center justify-between p-5 border-b border-border sticky top-0 bg-background">
                <h3 class="text-lg font-semibold">编辑 Token</h3>
                <button onclick="closeEditModal()" class="text-muted-foreground hover:text-foreground">
                    <svg class="h-3.5 w-3.5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="18" y1="6" x2="6" y2="18"/>
                        <line x1="6" y1="6" x2="18" y2="18"/>
                    </svg>
                </button>
            </div>
            <div class="p-5 space-y-5 max-h-[calc(100vh-200px)] overflow-y-auto">
                <input type="hidden" id="editTokenId">

                <div class="rounded-md border border-border/60 bg-muted/30 p-4 space-y-4">
                    <div class="flex items-center justify-between">
                        <p class="text-sm font-semibold">基础信息</p>
                        <span class="text-xs text-muted-foreground">只读</span>
                    </div>
                    <div class="grid gap-4 sm:grid-cols-2">
                        <div>
                            <label class="text-sm font-medium mb-2 block">Token ID</label>
                            <input id="editTokenIdDisplay" class="flex h-9 w-full rounded-md border border-input bg-muted/40 px-3 py-2 text-xs font-mono" readonly>
                        </div>
                        <div>
                            <label class="text-sm font-medium mb-2 block">邮箱</label>
                            <input id="editTokenEmail" class="flex h-9 w-full rounded-md border border-input bg-muted/40 px-3 py-2 text-sm" readonly>
                        </div>
                        <div class="sm:col-span-2">
                            <label class="text-sm font-medium mb-2 block">备注 <span class="text-muted-foreground text-xs">- 可选</span></label>
                            <input id="editTokenRemark" class="flex h-9 w-full rounded-md border border-input bg-background px-3 py-2 text-sm" placeholder="添加备注信息">
                        </div>
                    </div>
                </div>

                <div class="rounded-md border border-border/60 bg-background p-4 space-y-4">
                    <p class="text-sm font-semibold">认证凭据</p>
                    <div class="space-y-2">
                        <label class="text-sm font-medium">Access Token (AT) <span class="text-red-500">*</span></label>
                        <textarea id="editTokenAT" rows="3" class="flex w-full rounded-md border border-input bg-background px-3 py-2 text-sm font-mono resize-none" placeholder="请输入 Access Token 或使用下方 ST/RT 转换"></textarea>
                        <p class="text-xs text-muted-foreground">格式: eyJh... (JWT格式)</p>
                    </div>
                    <div class="grid gap-4 sm:grid-cols-2">
                        <div class="space-y-2">
                            <label class="text-sm font-medium">Session Token (ST) <span class="text-muted-foreground text-xs">- 可选</span></label>
                            <div class="flex gap-2">
                                <textarea id="editTokenST" rows="2" class="flex w-full rounded-md border border-input bg-background px-3 py-2 text-sm font-mono resize-none" placeholder="输入 Session Token 后点击转换"></textarea>
                                <button onclick="convertEditST2AT()" class="inline-flex items-center justify-center rounded-md bg-blue-600 text-white hover:bg-blue-700 px-4 whitespace-nowrap h-9">ST→AT</button>
                            </div>
                            <p class="text-xs text-muted-foreground">从浏览器 Cookie 中获取 __Secure-next-auth.session-token</p>
                        </div>
                        <div class="space-y-2">
                            <label class="text-sm font-medium">Refresh Token (RT) <span class="text-muted-foreground text-xs">- 可选</span></label>
                            <div class="flex gap-2">
                                <textarea id="editTokenRT" rows="2" class="flex w-full rounded-md border border-input bg-background px-3 py-2 text-sm font-mono resize-none" placeholder="输入 Refresh Token 后点击转换"></textarea>
                                <button onclick="convertEditRT2AT()" class="inline-flex items-center justify-center rounded-md bg-green-600 text-white hover:bg-green-700 px-4 whitespace-nowrap h-9">RT→AT</button>
                            </div>
                            <p class="text-xs text-muted-foreground">从移动端或其他客户端获取</p>
                            <p id="editRTRefreshHint" class="text-xs text-green-600 font-medium hidden">✓ RT已被刷新，已填入更新后的RT</p>
                        </div>
                    </div>
                </div>

                <div class="rounded-md border border-border/60 bg-background p-4 space-y-4">
                    <p class="text-sm font-semibold">可选配置</p>
                    <div class="grid gap-4 sm:grid-cols-2">
                        <div class="space-y-2">
                            <label class="text-sm font-medium">Client ID <span class="text-muted-foreground text-xs">- 可选</span></label>
                            <input id="editTokenClientId" class="flex h-9 w-full rounded-md border border-input bg-background px-3 py-2 text-sm font-mono" placeholder="留空使用默认值">
                            <p class="text-xs text-muted-foreground">用于 RT 刷新，留空使用默认 Client ID</p>
                        </div>
                        <div class="space-y-2">
                            <label class="text-sm font-medium">代理 <span class="text-muted-foreground text-xs">- 可选</span></label>
                            <input id="editTokenProxyUrl" class="flex h-9 w-full rounded-md border border-input bg-background px-3 py-2 text-sm font-mono" placeholder="http://127.0.0.1:7890 或 socks5://127.0.0.1:1080">
                            <p class="text-xs text-muted-foreground">支持 http 和 socks5 代理，留空使用系统设置的代理</p>
                        </div>
                    </div>
                </div>

                <div class="rounded-md border border-border/60 bg-background p-4 space-y-3">
                    <p class="text-sm font-semibold">功能开关</p>
                    <div class="grid gap-3 sm:grid-cols-2">
                        <div class="flex items-center justify-between gap-3 rounded-md border border-border/60 bg-background px-3 py-2">
                            <label class="inline-flex items-center gap-2 cursor-pointer">
                                <input type="checkbox" id="editTokenImageEnabled" class="h-4 w-4 rounded border-input">
                                <span class="text-sm font-medium">启用图片生成</span>
                            </label>
                            <input type="number" id="editTokenImageConcurrency" class="flex h-8 w-20 rounded-md border border-input bg-background px-2 py-1 text-sm" placeholder="并发数" title="并发数量限制：设置同时处理的最大请求数。-1表示不限制">
                        </div>
                        <div class="flex items-center justify-between gap-3 rounded-md border border-border/60 bg-background px-3 py-2">
                            <label class="inline-flex items-center gap-2 cursor-pointer">
                                <input type="checkbox" id="editTokenVideoEnabled" class="h-4 w-4 rounded border-input">
                                <span class="text-sm font-medium">启用视频生成</span>
                            </label>
                            <input type="number" id="editTokenVideoConcurrency" class="flex h-8 w-20 rounded-md border border-input bg-background px-2 py-1 text-sm" placeholder="并发数" title="并发数量限制：设置同时处理的最大请求数。-1表示不限制">
                        </div>
                    </div>
                    <p class="text-xs text-muted-foreground">并发数：-1 表示不限制</p>
                </div>
            </div>
            <div class="flex items-center justify-end gap-3 p-5 border-t border-border sticky bottom-0 bg-background">
                <button onclick="closeEditModal()" class="inline-flex items-center justify-center rounded-md border border-input bg-background hover:bg-accent h-9 px-5">取消</button>
                <button id="editTokenBtn" onclick="submitEditToken()" class="inline-flex items-center justify-center rounded-md bg-primary text-primary-foreground hover:bg-primary/90 h-9 px-5">
                    <span id="editTokenBtnText">保存</span>
                    <svg id="editTokenBtnSpinner" class="hidden animate-spin h-4 w-4 ml-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                </button>
            </div>
        </div>
    </div>

    <!-- Sora2 激活模态框 -->
    <div id="sora2Modal" class="hidden fixed inset-0 z-50 bg-black/80 flex items-center justify-center p-4">
        <div class="bg-background rounded-lg border border-border w-full max-w-md shadow-xl">
            <div class="flex items-center justify-between p-5 border-b border-border">
                <h3 class="text-lg font-semibold">激活 Sora2</h3>
                <button onclick="closeSora2Modal()" class="text-muted-foreground hover:text-foreground">
                    <svg class="h-3.5 w-3.5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="18" y1="6" x2="6" y2="18"/>
                        <line x1="6" y1="6" x2="18" y2="18"/>
                    </svg>
                </button>
            </div>
            <div class="p-5 space-y-4">
                <input type="hidden" id="sora2TokenId">
                <div>
                    <label class="text-sm font-medium mb-2 block">Sora2 邀请码</label>
                    <input id="sora2InviteCode" class="flex h-9 w-full rounded-md border border-input bg-background px-3 py-2 text-sm" placeholder="输入6位邀请码，例如：0ZSKEG">
                    <p class="text-xs text-muted-foreground mt-1">输入Sora2邀请码以激活该Token的Sora2功能</p>
                </div>
            </div>
            <div class="flex items-center justify-end gap-3 p-5 border-t border-border">
                <button onclick="closeSora2Modal()" class="inline-flex items-center justify-center rounded-md border border-input bg-background hover:bg-accent h-9 px-5">取消</button>
                <button id="sora2ActivateBtn" onclick="submitSora2Activate()" class="inline-flex items-center justify-center rounded-md bg-primary text-primary-foreground hover:bg-primary/90 h-9 px-5">
                    <span id="sora2ActivateBtnText">激活</span>
                    <svg id="sora2ActivateBtnSpinner" class="hidden animate-spin h-4 w-4 ml-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                </button>
            </div>
        </div>
    </div>

    <!-- Token 导入模态框 -->
    <div id="importModal" class="hidden fixed inset-0 z-50 bg-black/80 flex items-center justify-center p-4">
        <div class="bg-background rounded-lg border border-border w-full max-w-md shadow-xl">
            <div class="flex items-center justify-between p-5 border-b border-border">
                <h3 class="text-lg font-semibold">导入 Token</h3>
                <button onclick="closeImportModal()" class="text-muted-foreground hover:text-foreground">
                    <svg class="h-3.5 w-3.5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="18" y1="6" x2="6" y2="18"/>
                        <line x1="6" y1="6" x2="18" y2="18"/>
                    </svg>
                </button>
            </div>
            <div class="p-5 space-y-4">
                <div>
                    <label class="text-sm font-medium mb-2 block">选择 JSON 文件</label>
                    <input type="file" id="importFile" accept=".json" class="flex h-9 w-full rounded-md border border-input bg-background px-3 py-2 text-sm">
                    <p class="text-xs text-muted-foreground mt-1">选择导出的 Token JSON 文件进行导入</p>
                </div>
                <div class="rounded-md bg-blue-50 dark:bg-blue-900/20 p-3 border border-blue-200 dark:border-blue-800">
                    <p class="text-xs text-blue-800 dark:text-blue-200">
                        <strong>说明：</strong>如果邮箱存在则会覆盖更新，不存在则会新增
                    </p>
                </div>
            </div>
            <div class="flex items-center justify-end gap-3 p-5 border-t border-border">
                <button onclick="closeImportModal()" class="inline-flex items-center justify-center rounded-md border border-input bg-background hover:bg-accent h-9 px-5">取消</button>
                <button id="importBtn" onclick="submitImportTokens()" class="inline-flex items-center justify-center rounded-md bg-primary text-primary-foreground hover:bg-primary/90 h-9 px-5">
                    <span id="importBtnText">导入</span>
                    <svg id="importBtnSpinner" class="hidden animate-spin h-4 w-4 ml-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                </button>
            </div>
        </div>
    </div>

    <!-- 批量新增模态框 -->
    <div id="batchAddModal" class="hidden fixed inset-0 z-50 bg-black/80 flex items-center justify-center p-4">
        <div class="bg-background rounded-lg border border-border w-full max-w-2xl shadow-xl max-h-[90vh] flex flex-col">
            <div class="flex items-center justify-between p-5 border-b border-border">
                <h3 class="text-lg font-semibold">批量新增 Token</h3>
                <button onclick="closeBatchAddModal()" class="text-muted-foreground hover:text-foreground">
                    <svg class="h-3.5 w-3.5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="18" y1="6" x2="6" y2="18"/>
                        <line x1="6" y1="6" x2="18" y2="18"/>
                    </svg>
                </button>
            </div>
            <div class="p-5 overflow-y-auto flex-1 space-y-4">
                <div>
                    <label class="text-sm font-medium mb-2 block">Token 类型</label>
                    <div class="flex gap-4">
                        <label class="inline-flex items-center gap-2 cursor-pointer">
                            <input type="radio" name="batchTokenType" value="at" class="h-4 w-4" onchange="updateBatchPlaceholder()">
                            <span class="text-sm">Access Token (AT)</span>
                        </label>
                        <label class="inline-flex items-center gap-2 cursor-pointer">
                            <input type="radio" name="batchTokenType" value="rt" checked class="h-4 w-4" onchange="updateBatchPlaceholder()">
                            <span class="text-sm">Refresh Token (RT)</span>
                        </label>
                        <label class="inline-flex items-center gap-2 cursor-pointer">
                            <input type="radio" name="batchTokenType" value="st" class="h-4 w-4" onchange="updateBatchPlaceholder()">
                            <span class="text-sm">Session Token (ST)</span>
                        </label>
                    </div>
                </div>
                <div>
                    <label class="text-sm font-medium mb-2 block">Token 列表（一行一个）</label>
                    <textarea id="batchTokenList" class="flex min-h-[200px] w-full rounded-md border border-input bg-background px-3 py-2 text-sm font-mono" placeholder="每行输入一个 Refresh Token..."></textarea>
                    <p class="text-xs text-muted-foreground mt-1">每行一个 Token，空行会被忽略</p>
                </div>
                <div class="flex gap-4">
                    <label class="inline-flex items-center gap-2 cursor-pointer">
                        <input type="checkbox" id="batchImageEnabled" checked class="h-4 w-4 rounded border-input">
                        <span class="text-sm">图片生成</span>
                    </label>
                    <label class="inline-flex items-center gap-2 cursor-pointer">
                        <input type="checkbox" id="batchVideoEnabled" checked class="h-4 w-4 rounded border-input">
                        <span class="text-sm">视频生成</span>
                    </label>
                </div>
                <div id="batchProgress" class="hidden">
                    <div class="rounded-md bg-blue-50 dark:bg-blue-900/20 p-3 border border-blue-200 dark:border-blue-800">
                        <p class="text-sm text-blue-800 dark:text-blue-200 mb-2">
                            <strong>处理进度：</strong><span id="batchProgressText">0/0</span>
                        </p>
                        <div class="w-full bg-gray-200 rounded-full h-2">
                            <div id="batchProgressBar" class="bg-blue-600 h-2 rounded-full transition-all" style="width: 0%"></div>
                        </div>
                        <div id="batchLog" class="mt-3 max-h-32 overflow-y-auto text-xs font-mono space-y-1"></div>
                    </div>
                </div>
                <div class="rounded-md bg-yellow-50 dark:bg-yellow-900/20 p-3 border border-yellow-200 dark:border-yellow-800">
                    <p class="text-xs text-yellow-800 dark:text-yellow-200">
                        <strong>说明：</strong>AT模式直接批量添加，RT/ST模式会自动转换为AT后添加。如果邮箱已存在则跳过。
                    </p>
                </div>
            </div>
            <div class="flex items-center justify-end gap-3 p-5 border-t border-border">
                <button onclick="closeBatchAddModal()" class="inline-flex items-center justify-center rounded-md border border-input bg-background hover:bg-accent h-9 px-5">取消</button>
                <button id="batchAddBtn" onclick="submitBatchAdd()" class="inline-flex items-center justify-center rounded-md bg-primary text-primary-foreground hover:bg-primary/90 h-9 px-5">
                    <span id="batchAddBtnText">开始添加</span>
                    <svg id="batchAddBtnSpinner" class="hidden animate-spin h-4 w-4 ml-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                </button>
            </div>
        </div>
    </div>

    <!-- 批量操作进度模态框 -->
    <div id="batchOperationModal" class="hidden fixed inset-0 z-50 bg-black/80 flex items-center justify-center p-4">
        <div class="bg-background rounded-lg border border-border w-full max-w-lg shadow-xl">
            <div class="flex items-center justify-between p-5 border-b border-border">
                <h3 class="text-lg font-semibold" id="batchOperationTitle">批量操作</h3>
                <button onclick="stopBatchOperation()" class="text-muted-foreground hover:text-foreground" title="停止操作">
                    <svg class="h-5 w-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="18" y1="6" x2="6" y2="18"/>
                        <line x1="6" y1="6" x2="18" y2="18"/>
                    </svg>
                </button>
            </div>
            <div class="p-5 space-y-4">
                <div class="text-sm text-muted-foreground mb-2">
                    <span id="batchOperationStatus">准备中...</span>
                </div>
                <div class="w-full bg-gray-200 rounded-full h-2.5">
                    <div id="batchOperationProgressBar" class="bg-blue-600 h-2.5 rounded-full transition-all" style="width: 0%"></div>
                </div>
                <div class="flex justify-between text-sm text-muted-foreground">
                    <span id="batchOperationProgress">0/0</span>
                    <span id="batchOperationStats"></span>
                </div>
                <div id="batchOperationLog" class="max-h-48 overflow-y-auto text-xs font-mono space-y-1 bg-muted p-3 rounded-md"></div>
                <div class="flex justify-end gap-3 pt-2">
                    <button id="batchOperationStopBtn" onclick="stopBatchOperation()" class="inline-flex items-center justify-center rounded-md bg-destructive text-destructive-foreground hover:bg-destructive/90 h-9 px-5">
                        停止
                    </button>
                    <button id="batchOperationCloseBtn" onclick="closeBatchOperationModal()" class="hidden inline-flex items-center justify-center rounded-md bg-primary text-primary-foreground hover:bg-primary/90 h-9 px-5">
                        关闭
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let allTokens=[],filteredTokens=[],currentPage=1,pageSize=20;
        // 批量操作控制变量
        let batchOperationRunning=false,batchOperationAbortController=null;
        const $=(id)=>document.getElementById(id),
        checkAuth=()=>{const t=localStorage.getItem('adminToken');return t||(location.href='/login',null),t},
        apiRequest=async(url,opts={})=>{const t=checkAuth();if(!t)return null;const r=await fetch(url,{...opts,headers:{...opts.headers,Authorization:`Bearer ${t}`,'Content-Type':'application/json'}});return r.status===401?(localStorage.removeItem('adminToken'),location.href='/login',null):r},
        loadStats=async()=>{try{const r=await apiRequest('/api/stats');if(!r)return;const d=await r.json();$('statTotal').textContent=d.total_tokens||0;$('statActive').textContent=d.active_tokens||0;$('statImages').textContent=(d.today_images||0)+'/'+(d.total_images||0);$('statVideos').textContent=(d.today_videos||0)+'/'+(d.total_videos||0);$('statErrors').textContent=(d.today_errors||0)+'/'+(d.total_errors||0)}catch(e){console.error('加载统计失败:',e)}},
        loadTokens=async()=>{try{const r=await apiRequest('/api/tokens');if(!r)return;allTokens=await r.json();filterTokens()}catch(e){console.error('加载Token失败:',e)}},
        filterTokens=()=>{const filter=$('tokenStatusFilter').value;const now=new Date();filteredTokens=allTokens.filter(t=>{switch(filter){case 'active':return t.is_active;case 'inactive':return !t.is_active;case 'sora2':return t.sora2_supported===true;case 'nosora2':return t.sora2_supported!==true;case 'expired':return t.expiry_time&&new Date(t.expiry_time)<now;default:return true}});currentPage=1;renderTokens()},
        changePageSize=()=>{pageSize=parseInt($('pageSize').value);currentPage=1;renderTokens()},
        prevPage=()=>{if(currentPage>1){currentPage--;renderTokens()}},
        nextPage=()=>{const totalPages=Math.ceil(filteredTokens.length/pageSize);if(currentPage<totalPages){currentPage++;renderTokens()}},
        updatePagination=()=>{const total=filteredTokens.length;const totalPages=Math.max(1,Math.ceil(total/pageSize));const start=total===0?0:(currentPage-1)*pageSize+1;const end=Math.min(currentPage*pageSize,total);$('pageStart').textContent=start;$('pageEnd').textContent=end;$('totalTokens').textContent=total;$('currentPage').textContent=currentPage;$('totalPages').textContent=totalPages;$('prevPageBtn').disabled=currentPage<=1;$('nextPageBtn').disabled=currentPage>=totalPages},
        formatExpiry=exp=>{if(!exp)return'-';const d=new Date(exp),now=new Date(),diff=d-now;const dateStr=d.toLocaleDateString('zh-CN',{year:'numeric',month:'2-digit',day:'2-digit'}).replace(/\//g,'-');const timeStr=d.toLocaleTimeString('zh-CN',{hour:'2-digit',minute:'2-digit',hour12:false});if(diff<0)return`<span class="text-red-600">${dateStr} ${timeStr}</span>`;const days=Math.floor(diff/864e5);if(days<7)return`<span class="text-orange-600">${dateStr} ${timeStr}</span>`;return`${dateStr} ${timeStr}`},
        formatPlanType=type=>{if(!type)return'-';const typeMap={'chatgpt_team':'Team','chatgpt_plus':'Plus','chatgpt_pro':'Pro','chatgpt_free':'Free'};return typeMap[type]||type},
        formatSora2=(t)=>{if(t.sora2_supported===true){const remaining=t.sora2_total_count-t.sora2_redeemed_count;const tooltipText=`邀请码: ${t.sora2_invite_code||'无'}\n可用次数: ${remaining}/${t.sora2_total_count}\n已用次数: ${t.sora2_redeemed_count}`;return`<div class="inline-flex items-center gap-1 whitespace-nowrap"><span class="inline-flex items-center rounded px-2 py-0.5 text-xs bg-green-50 text-green-700 cursor-pointer whitespace-nowrap" title="${tooltipText}" onclick="copySora2Code('${t.sora2_invite_code||''}')">支持</span><span class="text-xs text-muted-foreground whitespace-nowrap" title="${tooltipText}">${remaining}/${t.sora2_total_count}</span></div>`}else if(t.sora2_supported===false){return`<span class="inline-flex items-center rounded px-2 py-0.5 text-xs bg-gray-100 text-gray-700 cursor-pointer whitespace-nowrap" title="点击使用邀请码激活" onclick="openSora2Modal(${t.id})">不支持</span>`}else{return'-'}},
        formatPlanTypeWithTooltip=(t)=>{const tooltipText=t.subscription_end?`套餐到期: ${new Date(t.subscription_end).toLocaleDateString('zh-CN',{year:'numeric',month:'2-digit',day:'2-digit'}).replace(/\//g,'-')} ${new Date(t.subscription_end).toLocaleTimeString('zh-CN',{hour:'2-digit',minute:'2-digit',hour12:false})}`:'';return`<span class="inline-flex items-center rounded px-2 py-0.5 text-xs bg-blue-50 text-blue-700 cursor-pointer whitespace-nowrap" title="${tooltipText||t.plan_title||'-'}">${formatPlanType(t.plan_type)}</span>`},
        formatSora2Remaining=(t)=>{if(t.sora2_supported===true){const remaining=t.sora2_remaining_count||0;return`<span class="text-xs whitespace-nowrap">${remaining}</span>`}else{return'-'}},
        formatClientId=(clientId)=>{if(!clientId)return'-';const short=clientId.substring(0,8)+'...';return`<span class="text-xs font-mono cursor-pointer hover:text-primary whitespace-nowrap" title="${clientId}" onclick="navigator.clipboard.writeText('${clientId}').then(()=>showToast('已复制','success'))">${short}</span>`},
        renderTokens=()=>{const tb=$('tokenTableBody');const start=(currentPage-1)*pageSize;const end=start+pageSize;const pageTokens=filteredTokens.slice(start,end);tb.innerHTML=pageTokens.map(t=>{const imageDisplay=t.image_enabled?`${t.image_count||0}`:'-';const videoDisplay=(t.video_enabled&&t.sora2_supported)?`${t.video_count||0}`:'-';const email=t.email||'-';const remark=t.remark||'-';const statusClass=t.is_active?'bg-green-50 text-green-700':'bg-gray-100 text-gray-700';const expiryText=formatExpiry(t.expiry_time);const planText=formatPlanTypeWithTooltip(t);const sora2Text=formatSora2(t);const remainingText=formatSora2Remaining(t);const toggleLabel=t.is_active?'禁用':'启用';const toggleClass=t.is_active?'border-orange-200 text-orange-700 hover:bg-orange-50':'border-emerald-200 text-emerald-700 hover:bg-emerald-50';return`<tr class="hover:bg-muted/40"><td class="py-2 px-3 align-middle"><div class="min-w-0 space-y-1"><div class="flex items-center gap-2 min-w-0"><span class="text-sm font-medium truncate" title="${email}">${email}</span><span class="inline-flex items-center rounded px-2 py-0.5 text-xs ${statusClass}">${t.is_active?'活跃':'禁用'}</span></div><div class="text-xs text-muted-foreground truncate" title="Client: ${t.client_id||'-'} · 备注: ${remark}">Client: ${formatClientId(t.client_id)} · 备注: ${remark}</div></div></td><td class="py-2 px-3 align-middle"><div class="space-y-1 text-xs"><div class="flex items-center gap-2 min-w-0 truncate">${planText}${sora2Text}</div><div class="text-muted-foreground truncate">到期: ${expiryText} · 可用: ${remainingText}</div></div></td><td class="py-2 px-3 align-middle"><div class="flex items-center justify-center gap-2 text-xs"><span class="inline-flex items-center rounded bg-purple-50 text-purple-700 px-2 py-0.5">视频 ${videoDisplay}</span><span class="inline-flex items-center rounded bg-blue-50 text-blue-700 px-2 py-0.5">图 ${imageDisplay}</span><span class="inline-flex items-center rounded bg-red-50 text-red-700 px-2 py-0.5">错 ${t.error_count||0}</span></div></td><td class="py-2 px-3 text-center align-middle"><div class="flex w-full items-center justify-center gap-1.5"><button onclick="testToken(${t.id})" class="inline-flex items-center justify-center rounded-md border border-border hover:bg-accent h-7 w-7" title="测试" aria-label="测试"><svg class="h-4 w-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="9"/><path d="M9 12l2 2 4-4"/></svg></button><button onclick="openEditModal(${t.id})" class="inline-flex items-center justify-center rounded-md border border-border hover:bg-accent h-7 w-7" title="编辑" aria-label="编辑"><svg class="h-4 w-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 20h9"/><path d="M16.5 3.5a2.1 2.1 0 0 1 3 3L7 19l-4 1 1-4 12.5-12.5z"/></svg></button><button onclick="toggleToken(${t.id},${t.is_active})" class="inline-flex items-center justify-center rounded-md border h-7 w-7 ${toggleClass}" title="${toggleLabel}" aria-label="${toggleLabel}"><svg class="h-4 w-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2v10"/><path d="M18.4 5.6a9 9 0 1 1-12.8 0"/></svg></button><button onclick="deleteToken(${t.id})" class="inline-flex items-center justify-center rounded-md border border-border hover:bg-destructive/10 hover:text-destructive h-7 w-7" title="删除" aria-label="删除"><svg class="h-4 w-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"/><path d="M19 6l-1 14a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2L5 6"/><path d="M10 11v6"/><path d="M14 11v6"/><path d="M9 6V4a1 1 0 0 1 1-1h4a1 1 0 0 1 1 1v2"/></svg></button></div></td></tr>`}).join('');updatePagination()},
        refreshTokens=async()=>{await loadTokens();await loadStats()},
        openAddModal=()=>$('addModal').classList.remove('hidden'),
        closeAddModal=()=>{$('addModal').classList.add('hidden');$('addTokenAT').value='';$('addTokenST').value='';$('addTokenRT').value='';$('addTokenClientId').value='';$('addTokenProxyUrl').value='';$('addTokenRemark').value='';$('addTokenImageEnabled').checked=true;$('addTokenVideoEnabled').checked=true;$('addTokenImageConcurrency').value='-1';$('addTokenVideoConcurrency').value='-1';$('addRTRefreshHint').classList.add('hidden')},
        openEditModal=(id)=>{const token=allTokens.find(t=>t.id===id);if(!token)return showToast('Token不存在','error');$('editTokenId').value=token.id;$('editTokenIdDisplay').value=token.id;$('editTokenEmail').value=token.email||'';$('editTokenAT').value=token.token||'';$('editTokenST').value=token.st||'';$('editTokenRT').value=token.rt||'';$('editTokenClientId').value=token.client_id||'';$('editTokenProxyUrl').value=token.proxy_url||'';$('editTokenRemark').value=token.remark||'';$('editTokenImageEnabled').checked=token.image_enabled!==false;$('editTokenVideoEnabled').checked=token.video_enabled!==false;$('editTokenImageConcurrency').value=token.image_concurrency||'-1';$('editTokenVideoConcurrency').value=token.video_concurrency||'-1';$('editModal').classList.remove('hidden')},
        closeEditModal=()=>{$('editModal').classList.add('hidden');$('editTokenId').value='';$('editTokenIdDisplay').value='';$('editTokenEmail').value='';$('editTokenAT').value='';$('editTokenST').value='';$('editTokenRT').value='';$('editTokenClientId').value='';$('editTokenProxyUrl').value='';$('editTokenRemark').value='';$('editTokenImageEnabled').checked=true;$('editTokenVideoEnabled').checked=true;$('editTokenImageConcurrency').value='';$('editTokenVideoConcurrency').value='';$('editRTRefreshHint').classList.add('hidden')},
        submitEditToken=async()=>{const id=parseInt($('editTokenId').value),at=$('editTokenAT').value.trim(),st=$('editTokenST').value.trim(),rt=$('editTokenRT').value.trim(),clientId=$('editTokenClientId').value.trim(),proxyUrl=$('editTokenProxyUrl').value.trim(),remark=$('editTokenRemark').value.trim(),imageEnabled=$('editTokenImageEnabled').checked,videoEnabled=$('editTokenVideoEnabled').checked,imageConcurrency=$('editTokenImageConcurrency').value?parseInt($('editTokenImageConcurrency').value):null,videoConcurrency=$('editTokenVideoConcurrency').value?parseInt($('editTokenVideoConcurrency').value):null;if(!id)return showToast('Token ID无效','error');if(!at)return showToast('请输入 Access Token','error');const btn=$('editTokenBtn'),btnText=$('editTokenBtnText'),btnSpinner=$('editTokenBtnSpinner');btn.disabled=true;btnText.textContent='保存中...';btnSpinner.classList.remove('hidden');try{const r=await apiRequest(`/api/tokens/${id}`,{method:'PUT',body:JSON.stringify({token:at,st:st||null,rt:rt||null,client_id:clientId||null,proxy_url:proxyUrl||null,remark:remark||null,image_enabled:imageEnabled,video_enabled:videoEnabled,image_concurrency:imageConcurrency,video_concurrency:videoConcurrency})});if(!r){btn.disabled=false;btnText.textContent='保存';btnSpinner.classList.add('hidden');return}const d=await r.json();if(d.success){closeEditModal();await refreshTokens();showToast('Token更新成功','success')}else{showToast('更新失败: '+(d.detail||d.message||'未知错误'),'error')}}catch(e){showToast('更新失败: '+e.message,'error')}finally{btn.disabled=false;btnText.textContent='保存';btnSpinner.classList.add('hidden')}},
        convertST2AT=async()=>{const st=$('addTokenST').value.trim();if(!st)return showToast('请先输入 Session Token','error');try{showToast('正在转换 ST→AT...','info');const r=await apiRequest('/api/tokens/st2at',{method:'POST',body:JSON.stringify({st:st})});if(!r)return;const d=await r.json();if(d.success&&d.access_token){$('addTokenAT').value=d.access_token;showToast('转换成功！AT已自动填入','success')}else{showToast('转换失败: '+(d.message||d.detail||'未知错误'),'error')}}catch(e){showToast('转换失败: '+e.message,'error')}},
        convertRT2AT=async()=>{const rt=$('addTokenRT').value.trim();if(!rt)return showToast('请先输入 Refresh Token','error');const hint=$('addRTRefreshHint');hint.classList.add('hidden');try{showToast('正在转换 RT→AT...','info');const r=await apiRequest('/api/tokens/rt2at',{method:'POST',body:JSON.stringify({rt:rt})});if(!r)return;const d=await r.json();if(d.success&&d.access_token){$('addTokenAT').value=d.access_token;if(d.refresh_token){$('addTokenRT').value=d.refresh_token;hint.classList.remove('hidden');showToast('转换成功！AT已自动填入，RT已被刷新并更新','success')}else{showToast('转换成功！AT已自动填入','success')}}else{showToast('转换失败: '+(d.message||d.detail||'未知错误'),'error')}}catch(e){showToast('转换失败: '+e.message,'error')}},
        convertEditST2AT=async()=>{const st=$('editTokenST').value.trim();if(!st)return showToast('请先输入 Session Token','error');try{showToast('正在转换 ST→AT...','info');const r=await apiRequest('/api/tokens/st2at',{method:'POST',body:JSON.stringify({st:st})});if(!r)return;const d=await r.json();if(d.success&&d.access_token){$('editTokenAT').value=d.access_token;showToast('转换成功！AT已自动填入','success')}else{showToast('转换失败: '+(d.message||d.detail||'未知错误'),'error')}}catch(e){showToast('转换失败: '+e.message,'error')}},
        convertEditRT2AT=async()=>{const rt=$('editTokenRT').value.trim();if(!rt)return showToast('请先输入 Refresh Token','error');const hint=$('editRTRefreshHint');hint.classList.add('hidden');try{showToast('正在转换 RT→AT...','info');const r=await apiRequest('/api/tokens/rt2at',{method:'POST',body:JSON.stringify({rt:rt})});if(!r)return;const d=await r.json();if(d.success&&d.access_token){$('editTokenAT').value=d.access_token;if(d.refresh_token){$('editTokenRT').value=d.refresh_token;hint.classList.remove('hidden');showToast('转换成功！AT已自动填入，RT已被刷新并更新','success')}else{showToast('转换成功！AT已自动填入','success')}}else{showToast('转换失败: '+(d.message||d.detail||'未知错误'),'error')}}catch(e){showToast('转换失败: '+e.message,'error')}},
        submitAddToken=async()=>{const at=$('addTokenAT').value.trim(),st=$('addTokenST').value.trim(),rt=$('addTokenRT').value.trim(),clientId=$('addTokenClientId').value.trim(),proxyUrl=$('addTokenProxyUrl').value.trim(),remark=$('addTokenRemark').value.trim(),imageEnabled=$('addTokenImageEnabled').checked,videoEnabled=$('addTokenVideoEnabled').checked,imageConcurrency=parseInt($('addTokenImageConcurrency').value)||(-1),videoConcurrency=parseInt($('addTokenVideoConcurrency').value)||(-1);if(!at)return showToast('请输入 Access Token 或使用 ST/RT 转换','error');const btn=$('addTokenBtn'),btnText=$('addTokenBtnText'),btnSpinner=$('addTokenBtnSpinner');btn.disabled=true;btnText.textContent='添加中...';btnSpinner.classList.remove('hidden');try{const r=await apiRequest('/api/tokens',{method:'POST',body:JSON.stringify({token:at,st:st||null,rt:rt||null,client_id:clientId||null,proxy_url:proxyUrl||null,remark:remark||null,image_enabled:imageEnabled,video_enabled:videoEnabled,image_concurrency:imageConcurrency,video_concurrency:videoConcurrency})});if(!r){btn.disabled=false;btnText.textContent='添加';btnSpinner.classList.add('hidden');return}if(r.status===409){const d=await r.json();const msg=d.detail||'Token 已存在';btn.disabled=false;btnText.textContent='添加';btnSpinner.classList.add('hidden');if(confirm(msg+'\n\n是否删除旧 Token 后重新添加？')){const existingToken=allTokens.find(t=>t.token===at);if(existingToken){const deleted=await deleteToken(existingToken.id,true);if(deleted){showToast('正在重新添加...','info');setTimeout(()=>submitAddToken(),500)}else{showToast('删除旧 Token 失败','error')}}}return}const d=await r.json();if(d.success){closeAddModal();await refreshTokens();showToast('Token添加成功','success')}else{showToast('添加失败: '+(d.detail||d.message||'未知错误'),'error')}}catch(e){showToast('添加失败: '+e.message,'error')}finally{btn.disabled=false;btnText.textContent='添加';btnSpinner.classList.add('hidden')}},
        testToken=async(id)=>{try{showToast('正在测试Token...','info');const r=await apiRequest(`/api/tokens/${id}/test`,{method:'POST'});if(!r)return;const d=await r.json();if(d.success&&d.status==='success'){await refreshTokens();let msg=`Token有效！用户: ${d.email||'未知'}`;if(d.sora2_supported){const remaining=d.sora2_total_count-d.sora2_redeemed_count;msg+=`\nSora2: 支持 (${remaining}/${d.sora2_total_count})`;if(d.sora2_remaining_count!==undefined){msg+=`\n可用次数: ${d.sora2_remaining_count}`}}showToast(msg,'success')}else{showToast(`Token无效: ${d.message||'未知错误'}`,'error')}}catch(e){showToast('测试失败: '+e.message,'error')}},
        activateUsername=async(id)=>{try{showToast('正在激活用户名...','info');const r=await apiRequest(`/api/tokens/${id}/activate-username`,{method:'POST'});if(!r)return;const d=await r.json();if(d.success){if(d.already_set){showToast(`用户名已存在: ${d.username}`,'info')}else{showToast(`用户名激活成功: ${d.username}`,'success')}}else{showToast(`激活失败: ${d.detail||d.message||'未知错误'}`,'error')}}catch(e){showToast('激活失败: '+e.message,'error')}},
        batchActivateUsernames=async()=>{$('batchTestMenu').classList.add('hidden');const tokens=allTokens.filter(t=>t.is_active);if(tokens.length===0){showToast('没有活跃的Token','info');return}if(!confirm(`将为 ${tokens.length} 个活跃Token激活用户名，是否继续？`))return;openBatchOperationModal('批量激活用户名');let activated=0,alreadySet=0,failed=0;for(let i=0;i<tokens.length;i++){if(!batchOperationRunning)break;const t=tokens[i];$('batchOperationStatus').textContent=`正在激活: ${t.email}`;updateBatchOperationProgress(i+1,tokens.length,activated,failed);$('batchOperationStats').textContent=`激活: ${activated}, 已存在: ${alreadySet}, 失败: ${failed}`;try{const r=await apiRequest(`/api/tokens/${t.id}/activate-username`,{method:'POST',signal:batchOperationAbortController?.signal});if(!r){addBatchOperationLog(`[${i+1}/${tokens.length}] ${t.email}: 请求失败`,'error');failed++;continue}const d=await r.json();if(d.success){if(d.already_set){addBatchOperationLog(`[${i+1}/${tokens.length}] ${t.email}: 已存在 ${d.username}`,'info');alreadySet++}else{addBatchOperationLog(`[${i+1}/${tokens.length}] ${t.email}: 激活成功 ${d.username}`,'success');activated++}}else{addBatchOperationLog(`[${i+1}/${tokens.length}] ${t.email}: ${d.detail||d.message||'失败'}`,'error');failed++}}catch(e){if(e.name==='AbortError')break;addBatchOperationLog(`[${i+1}/${tokens.length}] ${t.email}: ${e.message}`,'error');failed++}}await refreshTokens();finishBatchOperation(`完成！激活: ${activated}, 已存在: ${alreadySet}, 失败: ${failed}`)},
        toggleToken=async(id,isActive)=>{const action=isActive?'disable':'enable';try{const r=await apiRequest(`/api/tokens/${id}/${action}`,{method:'POST'});if(!r)return;const d=await r.json();d.success?(await refreshTokens(),showToast(isActive?'Token已禁用':'Token已启用','success')):showToast('操作失败','error')}catch(e){showToast('操作失败: '+e.message,'error')}},
        toggleTokenStatus=async(id,active)=>{try{const r=await apiRequest(`/api/tokens/${id}/status`,{method:'PUT',body:JSON.stringify({is_active:active})});if(!r)return;const d=await r.json();d.success?(await refreshTokens(),showToast('状态更新成功','success')):showToast('更新失败','error')}catch(e){showToast('更新失败: '+e.message,'error')}},
        handleTokenAction=(selectEl,id,isActive)=>{const action=selectEl.value;if(!action)return;selectEl.value='';if(action==='edit')return openEditModal(id);if(action==='test')return testToken(id);if(action==='activate')return activateUsername(id);if(action==='toggle')return toggleToken(id,isActive);if(action==='delete')return deleteToken(id)},
        deleteToken=async(id,skipConfirm=false)=>{if(!skipConfirm&&!confirm('确定要删除这个Token吗?'))return;try{const r=await apiRequest(`/api/tokens/${id}`,{method:'DELETE'});if(!r)return;const d=await r.json();if(d.success){await refreshTokens();if(!skipConfirm)showToast('删除成功','success');return true}else{if(!skipConfirm)showToast('删除失败','error');return false}}catch(e){if(!skipConfirm)showToast('删除失败: '+e.message,'error');return false}},
        copySora2Code=async(code)=>{if(!code){showToast('没有可复制的邀请码','error');return}try{if(navigator.clipboard&&navigator.clipboard.writeText){await navigator.clipboard.writeText(code);showToast(`邀请码已复制: ${code}`,'success')}else{const textarea=document.createElement('textarea');textarea.value=code;textarea.style.position='fixed';textarea.style.opacity='0';document.body.appendChild(textarea);textarea.select();const success=document.execCommand('copy');document.body.removeChild(textarea);if(success){showToast(`邀请码已复制: ${code}`,'success')}else{showToast('复制失败: 浏览器不支持','error')}}}catch(e){showToast('复制失败: '+e.message,'error')}},
        openSora2Modal=(id)=>{$('sora2TokenId').value=id;$('sora2InviteCode').value='';$('sora2Modal').classList.remove('hidden')},
        closeSora2Modal=()=>{$('sora2Modal').classList.add('hidden');$('sora2TokenId').value='';$('sora2InviteCode').value=''},
        openImportModal=()=>{$('importModal').classList.remove('hidden');$('importFile').value=''},
        closeImportModal=()=>{$('importModal').classList.add('hidden');$('importFile').value=''},
        openBatchAddModal=()=>{$('batchAddModal').classList.remove('hidden');$('batchTokenList').value='';$('batchProgress').classList.add('hidden');$('batchLog').innerHTML='';$('batchImageEnabled').checked=true;$('batchVideoEnabled').checked=true;updateBatchPlaceholder()},
        closeBatchAddModal=()=>{$('batchAddModal').classList.add('hidden');$('batchTokenList').value='';$('batchProgress').classList.add('hidden');$('batchLog').innerHTML=''},
        updateBatchPlaceholder=()=>{const type=document.querySelector('input[name="batchTokenType"]:checked').value;const placeholders={'at':'每行输入一个 Access Token...','rt':'每行输入一个 Refresh Token...','st':'每行输入一个 Session Token...'};$('batchTokenList').placeholder=placeholders[type]||'每行输入一个 Token...'},
        addBatchLog=(msg,type='info')=>{const log=$('batchLog');const color=type==='success'?'text-green-600':type==='error'?'text-red-600':'text-gray-600';log.innerHTML+=`<div class="${color}">${msg}</div>`;log.scrollTop=log.scrollHeight},
        submitBatchAdd=async()=>{const tokenType=document.querySelector('input[name="batchTokenType"]:checked').value;const tokenList=$('batchTokenList').value.trim().split('\n').map(t=>t.trim()).filter(t=>t.length>0);const imageEnabled=$('batchImageEnabled').checked;const videoEnabled=$('batchVideoEnabled').checked;if(tokenList.length===0)return showToast('请输入至少一个Token','error');const btn=$('batchAddBtn'),btnText=$('batchAddBtnText'),btnSpinner=$('batchAddBtnSpinner');btn.disabled=true;btnText.textContent='处理中...';btnSpinner.classList.remove('hidden');$('batchProgress').classList.remove('hidden');$('batchLog').innerHTML='';if(tokenType==='at'){addBatchLog(`开始批量添加 ${tokenList.length} 个 Access Token...`);try{const tokens=tokenList.map(t=>({token:t,image_enabled:imageEnabled,video_enabled:videoEnabled,image_concurrency:-1,video_concurrency:-1}));const r=await apiRequest('/api/tokens/batch-add',{method:'POST',body:JSON.stringify({tokens:tokens})});if(!r){addBatchLog('批量添加失败: 请求错误','error');btn.disabled=false;btnText.textContent='开始添加';btnSpinner.classList.add('hidden');return}const d=await r.json();if(d.success){const details=d.details||[];details.forEach((item,i)=>{const status=item.status==='added'?'success':item.status==='skipped'?'info':'error';addBatchLog(`[${i+1}/${details.length}] ${item.email||item.token}: ${item.message}`,status)});$('batchProgressText').textContent=`${d.total}/${d.total}`;$('batchProgressBar').style.width='100%';await refreshTokens();showToast(`批量添加完成！成功: ${d.added}, 失败: ${d.failed}, 跳过: ${d.skipped}`,'success')}else{addBatchLog('批量添加失败: '+(d.detail||d.message||'未知错误'),'error')}}catch(e){addBatchLog('批量添加错误: '+e.message,'error')}btn.disabled=false;btnText.textContent='开始添加';btnSpinner.classList.add('hidden');return}let success=0,failed=0,skipped=0;const total=tokenList.length;for(let i=0;i<tokenList.length;i++){const token=tokenList[i];$('batchProgressText').textContent=`${i+1}/${total}`;$('batchProgressBar').style.width=`${((i+1)/total)*100}%`;addBatchLog(`[${i+1}/${total}] 正在处理...`);try{const convertUrl=tokenType==='rt'?'/api/tokens/rt2at':'/api/tokens/st2at';const convertBody=tokenType==='rt'?{rt:token}:{st:token};const convertR=await apiRequest(convertUrl,{method:'POST',body:JSON.stringify(convertBody)});if(!convertR){addBatchLog(`[${i+1}/${total}] 转换失败: 请求错误`,'error');failed++;continue}const convertD=await convertR.json();if(!convertD.success||!convertD.access_token){addBatchLog(`[${i+1}/${total}] 转换失败: ${convertD.message||convertD.detail||'未知错误'}`,'error');failed++;continue}const at=convertD.access_token;const newRt=convertD.refresh_token||null;const addR=await apiRequest('/api/tokens',{method:'POST',body:JSON.stringify({token:at,st:tokenType==='st'?token:null,rt:tokenType==='rt'?(newRt||token):null,image_enabled:imageEnabled,video_enabled:videoEnabled,image_concurrency:-1,video_concurrency:-1})});if(!addR){addBatchLog(`[${i+1}/${total}] 添加失败: 请求错误`,'error');failed++;continue}if(addR.status===409){addBatchLog(`[${i+1}/${total}] 跳过: Token已存在`,'info');skipped++;continue}const addD=await addR.json();if(addD.success){addBatchLog(`[${i+1}/${total}] 成功: ${addD.email||'已添加'}`,'success');success++}else{addBatchLog(`[${i+1}/${total}] 添加失败: ${addD.detail||addD.message||'未知错误'}`,'error');failed++}}catch(e){addBatchLog(`[${i+1}/${total}] 错误: ${e.message}`,'error');failed++}}btn.disabled=false;btnText.textContent='开始添加';btnSpinner.classList.add('hidden');await refreshTokens();showToast(`批量添加完成！成功: ${success}, 失败: ${failed}, 跳过: ${skipped}`,'success')},
        exportTokens=()=>{if(allTokens.length===0){showToast('没有Token可导出','error');return}const exportData=allTokens.map(t=>({email:t.email,access_token:t.token,session_token:t.st||null,refresh_token:t.rt||null,proxy_url:t.proxy_url||null,remark:t.remark||null,is_active:t.is_active,image_enabled:t.image_enabled!==false,video_enabled:t.video_enabled!==false,image_concurrency:t.image_concurrency||(-1),video_concurrency:t.video_concurrency||(-1)}));const dataStr=JSON.stringify(exportData,null,2);const dataBlob=new Blob([dataStr],{type:'application/json'});const url=URL.createObjectURL(dataBlob);const link=document.createElement('a');link.href=url;link.download=`tokens_${new Date().toISOString().split('T')[0]}.json`;document.body.appendChild(link);link.click();document.body.removeChild(link);URL.revokeObjectURL(url);showToast(`已导出 ${allTokens.length} 个Token`,'success')},
        submitImportTokens=async()=>{const fileInput=$('importFile');if(!fileInput.files||fileInput.files.length===0){showToast('请选择文件','error');return}const file=fileInput.files[0];if(!file.name.endsWith('.json')){showToast('请选择JSON文件','error');return}try{const fileContent=await file.text();const importData=JSON.parse(fileContent);if(!Array.isArray(importData)){showToast('JSON格式错误：应为数组','error');return}if(importData.length===0){showToast('JSON文件为空','error');return}const btn=$('importBtn'),btnText=$('importBtnText'),btnSpinner=$('importBtnSpinner');btn.disabled=true;btnText.textContent='导入中...';btnSpinner.classList.remove('hidden');try{const r=await apiRequest('/api/tokens/import',{method:'POST',body:JSON.stringify({tokens:importData})});if(!r){btn.disabled=false;btnText.textContent='导入';btnSpinner.classList.add('hidden');return}const d=await r.json();if(d.success){closeImportModal();await refreshTokens();const msg=`导入成功！新增: ${d.added||0}, 更新: ${d.updated||0}`;showToast(msg,'success')}else{showToast('导入失败: '+(d.detail||d.message||'未知错误'),'error')}}catch(e){showToast('导入失败: '+e.message,'error')}finally{btn.disabled=false;btnText.textContent='导入';btnSpinner.classList.add('hidden')}}catch(e){showToast('文件解析失败: '+e.message,'error')}},
        submitSora2Activate=async()=>{const tokenId=parseInt($('sora2TokenId').value),inviteCode=$('sora2InviteCode').value.trim();if(!tokenId)return showToast('Token ID无效','error');if(!inviteCode)return showToast('请输入邀请码','error');if(inviteCode.length!==6)return showToast('邀请码必须是6位','error');const btn=$('sora2ActivateBtn'),btnText=$('sora2ActivateBtnText'),btnSpinner=$('sora2ActivateBtnSpinner');btn.disabled=true;btnText.textContent='激活中...';btnSpinner.classList.remove('hidden');try{showToast('正在激活Sora2...','info');const r=await apiRequest(`/api/tokens/${tokenId}/sora2/activate?invite_code=${inviteCode}`,{method:'POST'});if(!r){btn.disabled=false;btnText.textContent='激活';btnSpinner.classList.add('hidden');return}const d=await r.json();if(d.success){closeSora2Modal();await refreshTokens();if(d.already_accepted){showToast('Sora2已激活（之前已接受）','success')}else{showToast(`Sora2激活成功！邀请码: ${d.invite_code||'无'}`,'success')}}else{showToast('激活失败: '+(d.message||'未知错误'),'error')}}catch(e){showToast('激活失败: '+e.message,'error')}finally{btn.disabled=false;btnText.textContent='激活';btnSpinner.classList.add('hidden')}},
        loadAdminConfig=async()=>{try{const r=await apiRequest('/api/admin/config');if(!r)return;const d=await r.json();$('cfgErrorBan').value=d.error_ban_threshold||3;$('cfgAdminUsername').value=d.admin_username||'admin';$('cfgCurrentAPIKey').value=d.api_key||'';$('cfgDebugEnabled').checked=d.debug_enabled||false}catch(e){console.error('加载配置失败:',e)}},
        saveAdminConfig=async()=>{try{const r=await apiRequest('/api/admin/config',{method:'POST',body:JSON.stringify({error_ban_threshold:parseInt($('cfgErrorBan').value)||3})});if(!r)return;const d=await r.json();d.success?showToast('配置保存成功','success'):showToast('保存失败','error')}catch(e){showToast('保存失败: '+e.message,'error')}},
        updateAdminPassword=async()=>{const username=$('cfgAdminUsername').value.trim(),oldPwd=$('cfgOldPassword').value.trim(),newPwd=$('cfgNewPassword').value.trim();if(!oldPwd||!newPwd)return showToast('请输入旧密码和新密码','error');if(newPwd.length<4)return showToast('新密码至少4个字符','error');try{const r=await apiRequest('/api/admin/password',{method:'POST',body:JSON.stringify({username:username||undefined,old_password:oldPwd,new_password:newPwd})});if(!r)return;const d=await r.json();if(d.success){showToast('密码修改成功，请重新登录','success');setTimeout(()=>{localStorage.removeItem('adminToken');location.href='/login'},2000)}else{showToast('修改失败: '+(d.detail||'未知错误'),'error')}}catch(e){showToast('修改失败: '+e.message,'error')}},
        updateAPIKey=async()=>{const newKey=$('cfgNewAPIKey').value.trim();if(!newKey)return showToast('请输入新的 API Key','error');if(newKey.length<6)return showToast('API Key 至少6个字符','error');if(!confirm('确定要更新 API Key 吗？更新后需要通知所有客户端使用新密钥。'))return;try{const r=await apiRequest('/api/admin/apikey',{method:'POST',body:JSON.stringify({new_api_key:newKey})});if(!r)return;const d=await r.json();if(d.success){showToast('API Key 更新成功','success');$('cfgCurrentAPIKey').value=newKey;$('cfgNewAPIKey').value=''}else{showToast('更新失败: '+(d.detail||'未知错误'),'error')}}catch(e){showToast('更新失败: '+e.message,'error')}},
        toggleDebugMode=async()=>{const enabled=$('cfgDebugEnabled').checked;try{const r=await apiRequest('/api/admin/debug',{method:'POST',body:JSON.stringify({enabled:enabled})});if(!r)return;const d=await r.json();if(d.success){showToast(enabled?'调试模式已开启':'调试模式已关闭','success')}else{showToast('操作失败: '+(d.detail||'未知错误'),'error');$('cfgDebugEnabled').checked=!enabled}}catch(e){showToast('操作失败: '+e.message,'error');$('cfgDebugEnabled').checked=!enabled}},
        loadProxyConfig=async()=>{try{const r=await apiRequest('/api/proxy/config');if(!r)return;const d=await r.json();$('cfgProxyEnabled').checked=d.proxy_enabled||false;$('cfgProxyUrl').value=d.proxy_url||'';$('cfgProxyPoolEnabled').checked=d.proxy_pool_enabled||false;if(d.proxy_pool_count>0){$('proxyPoolCount').classList.remove('hidden');$('proxyPoolCountValue').textContent=d.proxy_pool_count}else{$('proxyPoolCount').classList.add('hidden')}}catch(e){console.error('加载代理配置失败:',e)}},
        saveProxyConfig=async()=>{try{const r=await apiRequest('/api/proxy/config',{method:'POST',body:JSON.stringify({proxy_enabled:$('cfgProxyEnabled').checked,proxy_url:$('cfgProxyUrl').value.trim(),proxy_pool_enabled:$('cfgProxyPoolEnabled').checked})});if(!r)return;const d=await r.json();if(d.success){showToast('代理配置保存成功','success');await loadProxyConfig()}else{showToast('保存失败','error')}}catch(e){showToast('保存失败: '+e.message,'error')}},
        loadProxyPool=async()=>{try{const r=await apiRequest('/api/proxy/pool');if(!r)return;const d=await r.json();if(d.success){$('cfgProxyPool').value=d.content||''}}catch(e){console.error('加载代理池失败:',e);showToast('加载代理池失败: '+e.message,'error')}},
        splitConcatenatedProxies=(text)=>{return text.split(/(?=https?:\/\/)|(?=socks5h?:\/\/)|(?=st5\s+)/i).map(p=>p.trim()).filter(p=>p)},
        saveProxyPool=async()=>{try{let content=$('cfgProxyPool').value;const lines=content.split('\n');const processedLines=[];const validFormats=[/^https?:\/\/[^:]+:[^@]+@[^:]+:\d+$/,/^https?:\/\/[^:]+:\d+$/,/^socks5h?:\/\/[^:]+:[^@]+@[^:]+:\d+$/,/^socks5h?:\/\/[^:]+:\d+$/,/^socks5h?:\/\/[^:]+:\d+:[^:]+:.+$/,/^[^:]+:\d+$/,/^[^:]+:\d+:[^:]+:.+$/,/^st5\s+[^:]+:\d+:[^:]+:.+$/i];for(const line of lines){const trimmed=line.trim();if(!trimmed||trimmed.startsWith('#')){processedLines.push(line);continue}const split=splitConcatenatedProxies(trimmed);processedLines.push(...split)}content=processedLines.join('\n');$('cfgProxyPool').value=content;const invalidLines=[];const finalLines=content.split('\n');for(let i=0;i<finalLines.length;i++){const line=finalLines[i].trim();if(!line||line.startsWith('#'))continue;const isValid=validFormats.some(regex=>regex.test(line));if(!isValid){invalidLines.push({line:i+1,content:line})}}if(invalidLines.length>0){const errMsg=invalidLines.slice(0,5).map(e=>`第${e.line}行: ${e.content.substring(0,50)}${e.content.length>50?'...':''}`).join('\n');showToast(`格式错误！支持格式:\n• http(s)://user:pass@host:port\n• http(s)://host:port\n• socks5(h)://user:pass@host:port\n• socks5(h)://host:port\n• socks5://host:port:user:pass\n• st5 host:port:user:pass\n• host:port\n• host:port:user:pass\n\n错误行:\n${errMsg}${invalidLines.length>5?`\n...还有${invalidLines.length-5}行错误`:''}`,'error');return}const r=await apiRequest('/api/proxy/pool',{method:'POST',body:JSON.stringify({content:content})});if(!r)return;const d=await r.json();if(d.success){showToast('代理池保存成功','success');await loadProxyConfig()}else{showToast('保存失败: '+(d.message||'未知错误'),'error')}}catch(e){showToast('保存失败: '+e.message,'error')}},
        testAllProxies=async(removeInvalid=false)=>{let proxyContent=$('cfgProxyPool').value.trim();if(!proxyContent){showToast('代理池为空','info');return}const validFormats=[/^https?:\/\/[^:]+:[^@]+@[^:]+:\d+$/,/^https?:\/\/[^:]+:\d+$/,/^socks5h?:\/\/[^:]+:[^@]+@[^:]+:\d+$/,/^socks5h?:\/\/[^:]+:\d+$/,/^socks5h?:\/\/[^:]+:\d+:[^:]+:.+$/,/^[^:]+:\d+$/,/^[^:]+:\d+:[^:]+:.+$/,/^st5\s+[^:]+:\d+:[^:]+:.+$/i];const allProxies=[];proxyContent.split('\n').forEach(line=>{const trimmed=line.trim();if(!trimmed||trimmed.startsWith('#'))return;const split=splitConcatenatedProxies(trimmed);allProxies.push(...split)});const proxies=allProxies.filter(p=>validFormats.some(regex=>regex.test(p)));if(proxies.length===0){showToast('没有有效格式的代理','info');return}if(!confirm(`将检测 ${proxies.length} 个代理${removeInvalid?'，无效代理将被剔除':''}，是否继续？`))return;openBatchOperationModal(removeInvalid?'检测并剔除无效代理':'检测全部代理');let valid=0,invalid=0;const validProxies=[];const results=[];for(let i=0;i<proxies.length;i++){if(!batchOperationRunning)break;const proxy=proxies[i];$('batchOperationStatus').textContent=`正在检测: ${proxy}`;updateBatchOperationProgress(i+1,proxies.length,valid,invalid);try{const r=await apiRequest('/api/proxy/test-single',{method:'POST',body:JSON.stringify({proxy_url:proxy}),signal:batchOperationAbortController?.signal});if(!r){addBatchOperationLog(`[${i+1}/${proxies.length}] ${proxy}: 请求失败`,'error');invalid++;results.push({proxy,success:false,error:'请求失败'});continue}const d=await r.json();if(d.success&&d.valid){addBatchOperationLog(`[${i+1}/${proxies.length}] ${proxy}: 有效 (${d.latency||0}ms)`,'success');valid++;validProxies.push(proxy);results.push({proxy,success:true,latency:d.latency||0})}else{addBatchOperationLog(`[${i+1}/${proxies.length}] ${proxy}: ${d.error||'无效'}`,'error');invalid++;results.push({proxy,success:false,error:d.error||'无效'})}}catch(e){if(e.name==='AbortError')break;addBatchOperationLog(`[${i+1}/${proxies.length}] ${proxy}: ${e.message}`,'error');invalid++;results.push({proxy,success:false,error:e.message})}}if(removeInvalid&&batchOperationRunning&&validProxies.length<proxies.length){const comments=proxyContent.split('\n').filter(p=>p.trim().startsWith('#'));const newContent=[...comments,...validProxies].join('\n');$('cfgProxyPool').value=newContent;await saveProxyPool()}$('proxyTestResults').classList.remove('hidden');$('proxyTestTotal').textContent=proxies.length;$('proxyTestValid').textContent=valid;$('proxyTestInvalid').textContent=invalid;$('proxyTestRemoved').textContent=removeInvalid?(proxies.length-validProxies.length):0;const list=$('proxyTestList');list.innerHTML='';results.forEach(r=>{const div=document.createElement('div');div.className='flex items-center justify-between p-1 rounded '+(r.success?'bg-green-50':'bg-red-50');div.innerHTML='<span class="truncate flex-1">'+(r.proxy||'未知')+'</span><span class="ml-2 '+(r.success?'text-green-600':'text-red-600')+'">'+(r.success?'✓ '+r.latency+'ms':'✗ '+r.error)+'</span>';list.appendChild(div)});finishBatchOperation(`完成！有效: ${valid}, 无效: ${invalid}${removeInvalid?`, 已剔除: ${proxies.length-validProxies.length}`:''}`)},
        loadWatermarkFreeConfig=async()=>{try{const r=await apiRequest('/api/watermark-free/config');if(!r)return;const d=await r.json();$('cfgWatermarkFreeEnabled').checked=d.watermark_free_enabled||false;$('cfgParseMethod').value=d.parse_method||'third_party';$('cfgCustomParseUrl').value=d.custom_parse_url||'';$('cfgCustomParseToken').value=d.custom_parse_token||'';toggleWatermarkFreeOptions();toggleCustomParseOptions()}catch(e){console.error('加载无水印模式配置失败:',e)}},
        saveWatermarkFreeConfig=async()=>{try{const enabled=$('cfgWatermarkFreeEnabled').checked,parseMethod=$('cfgParseMethod').value,customUrl=$('cfgCustomParseUrl').value.trim(),customToken=$('cfgCustomParseToken').value.trim();if(enabled&&parseMethod==='custom'){if(!customUrl)return showToast('请输入解析服务器地址','error');if(!customToken)return showToast('请输入访问密钥','error')}const r=await apiRequest('/api/watermark-free/config',{method:'POST',body:JSON.stringify({watermark_free_enabled:enabled,parse_method:parseMethod,custom_parse_url:customUrl||null,custom_parse_token:customToken||null})});if(!r)return;const d=await r.json();d.success?showToast('无水印模式配置保存成功','success'):showToast('保存失败','error')}catch(e){showToast('保存失败: '+e.message,'error')}},
        toggleWatermarkFreeOptions=()=>{const enabled=$('cfgWatermarkFreeEnabled').checked;$('watermarkFreeOptions').style.display=enabled?'block':'none'},
        toggleCustomParseOptions=()=>{const method=$('cfgParseMethod').value;$('customParseOptions').style.display=method==='custom'?'block':'none'},
        // Cloudflare Solver functions
        loadCloudflareSolverConfig=async()=>{try{const r=await apiRequest('/api/cloudflare/config');if(!r)return;const d=await r.json();if(d.success&&d.config){$('cfgCloudflareSolverEnabled').checked=d.config.solver_enabled||false;$('cfgCloudflareSolverUrl').value=d.config.solver_api_url||'http://localhost:8000/v1/challenge';toggleCloudflareSolverOptions()}}catch(e){console.error('加载Cloudflare Solver配置失败:',e)}},
        saveCloudflareSolverConfig=async()=>{try{const enabled=$('cfgCloudflareSolverEnabled').checked,apiUrl=$('cfgCloudflareSolverUrl').value.trim();if(enabled&&!apiUrl)return showToast('请输入 Solver API 地址','error');const r=await apiRequest('/api/cloudflare/config',{method:'POST',body:JSON.stringify({solver_enabled:enabled,solver_api_url:apiUrl||null})});if(!r)return;const d=await r.json();d.success?showToast('Cloudflare Solver 配置保存成功','success'):showToast('保存失败: '+(d.message||'未知错误'),'error')}catch(e){showToast('保存失败: '+e.message,'error')}},
        toggleCloudflareSolverOptions=()=>{const enabled=$('cfgCloudflareSolverEnabled').checked;$('cloudflareSolverOptions').style.display=enabled?'block':'none'};
        // Cloudflare State functions
        let cfStateTimer=null;
        const loadCfState=async()=>{try{const r=await apiRequest('/api/cloudflare/state');if(!r)return;const d=await r.json();if(d.success&&d.state){updateCfStateDisplay(d.state)}}catch(e){console.error('加载CF状态失败:',e)}},
        updateCfStateDisplay=(state)=>{const indicator=$('cfStatusIndicator'),statusText=$('cfStatusText'),remaining=$('cfRemainingTime'),display=$('cfStateDisplay');if(state.is_valid){indicator.className='w-3 h-3 rounded-full bg-green-500';statusText.textContent='有效';statusText.className='text-sm font-medium text-green-600';display.className='rounded-md p-4 border border-green-200 bg-green-50 dark:bg-green-900/20 dark:border-green-800';startCfCountdown(state.remaining_seconds)}else if(state.has_credentials){indicator.className='w-3 h-3 rounded-full bg-yellow-500';statusText.textContent='已过期';statusText.className='text-sm font-medium text-yellow-600';display.className='rounded-md p-4 border border-yellow-200 bg-yellow-50 dark:bg-yellow-900/20 dark:border-yellow-800';remaining.textContent='已过期';stopCfCountdown()}else{indicator.className='w-3 h-3 rounded-full bg-gray-400';statusText.textContent='无凭据';statusText.className='text-sm font-medium text-muted-foreground';display.className='rounded-md p-4 border';remaining.textContent='';stopCfCountdown()}$('cfUserAgent').textContent=state.user_agent||'-';$('cfCookiesCount').textContent=state.cookies_count||0;$('cfLastUpdated').textContent=state.last_updated?new Date(state.last_updated).toLocaleString():'从未'},
        startCfCountdown=(initialSeconds)=>{stopCfCountdown();let seconds=initialSeconds;const updateDisplay=()=>{if(seconds<=0){$('cfRemainingTime').textContent='已过期';loadCfState();return}const m=Math.floor(seconds/60),s=seconds%60;$('cfRemainingTime').textContent=`剩余 ${m}:${s.toString().padStart(2,'0')}`;seconds--;cfStateTimer=setTimeout(updateDisplay,1000)};updateDisplay()},
        stopCfCountdown=()=>{if(cfStateTimer){clearTimeout(cfStateTimer);cfStateTimer=null}},
        refreshCfCredentials=async()=>{console.log('refreshCfCredentials called');const btn=$('cfRefreshBtn'),icon=$('cfRefreshIcon'),spinner=$('cfRefreshSpinner'),text=$('cfRefreshText');if(!btn){console.error('cfRefreshBtn not found');return}btn.disabled=true;if(icon)icon.classList.add('hidden');if(spinner)spinner.classList.remove('hidden');if(text)text.textContent='获取中...';try{console.log('Sending request to /api/cloudflare/refresh');showToast('正在获取凭据，请稍候...','info');const r=await apiRequest('/api/cloudflare/refresh',{method:'POST'});console.log('Response received:',r);if(!r){btn.disabled=false;if(icon)icon.classList.remove('hidden');if(spinner)spinner.classList.add('hidden');if(text)text.textContent='获取凭据';return}const d=await r.json();console.log('Response data:',d);if(d.success){showToast('凭据获取成功','success');if(d.state)updateCfStateDisplay(d.state)}else{showToast('获取失败: '+(d.message||'未知错误'),'error')}}catch(e){console.error('Error:',e);showToast('获取失败: '+e.message,'error')}finally{btn.disabled=false;if(icon)icon.classList.remove('hidden');if(spinner)spinner.classList.add('hidden');if(text)text.textContent='获取凭据'}},
        clearCfCredentials=async()=>{if(!confirm('确定要清除 Cloudflare 凭据吗？'))return;try{const r=await apiRequest('/api/cloudflare/clear',{method:'POST'});if(!r)return;const d=await r.json();if(d.success){showToast('凭据已清除','success');if(d.state)updateCfStateDisplay(d.state)}else{showToast('清除失败','error')}}catch(e){showToast('清除失败: '+e.message,'error')}},
        toggleCacheOptions=()=>{const enabled=$('cfgCacheEnabled').checked;$('cacheOptions').style.display=enabled?'block':'none'},
        toggleLambdaOptions=()=>{const enabled=$('cfgLambdaEnabled').checked;$('lambdaOptions').style.display=enabled?'block':'none'},
        renderLambdaUrls=(urls)=>{console.log('渲染Lambda URLs:',urls);const container=$('lambdaUrlsContainer');container.innerHTML='';if(!urls||!Array.isArray(urls)||urls.length===0){addLambdaUrl();return}urls.forEach((url,index)=>{const div=document.createElement('div');div.className='flex items-center gap-2';div.innerHTML=`<input type="text" class="lambda-url-input flex h-9 flex-1 rounded-md border border-input bg-background px-3 py-2 text-sm" placeholder="https://xxx.execute-api.xxx.amazonaws.com/prod/create" value="${url||''}"><button type="button" onclick="removeLambdaUrl(${index})" class="inline-flex items-center justify-center text-xs transition-colors hover:bg-destructive hover:text-destructive-foreground h-7 w-7 border border-input rounded-md"><svg class="h-3 w-3" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg></button>`;container.appendChild(div)})},
        addLambdaUrl=()=>{const container=$('lambdaUrlsContainer');const div=document.createElement('div');div.className='flex items-center gap-2';const index=container.children.length;div.innerHTML=`<input type="text" class="lambda-url-input flex h-9 flex-1 rounded-md border border-input bg-background px-3 py-2 text-sm" placeholder="https://xxx.execute-api.xxx.amazonaws.com/prod/create"><button type="button" onclick="removeLambdaUrl(${index})" class="inline-flex items-center justify-center text-xs transition-colors hover:bg-destructive hover:text-destructive-foreground h-7 w-7 border border-input rounded-md"><svg class="h-3 w-3" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg></button>`;container.appendChild(div)},
        removeLambdaUrl=(index)=>{const container=$('lambdaUrlsContainer');const items=Array.from(container.children);if(items.length<=1)return showToast('至少需要保留一个URL','error');if(items[index])items[index].remove();updateLambdaUrlIndices()},
        updateLambdaUrlIndices=()=>{const container=$('lambdaUrlsContainer');Array.from(container.children).forEach((item,index)=>{const button=item.querySelector('button');if(button)button.setAttribute('onclick',`removeLambdaUrl(${index})`)})},
        getLambdaUrls=()=>{const inputs=document.querySelectorAll('.lambda-url-input');return Array.from(inputs).map(input=>input.value.trim()).filter(url=>url)},
        loadCacheConfig=async()=>{try{console.log('开始加载缓存配置...');const r=await apiRequest('/api/cache/config');if(!r){console.error('API请求失败');return}const d=await r.json();console.log('缓存配置数据:',d);if(d.success&&d.config){const enabled=d.config.enabled!==false;const timeout=d.config.timeout||7200;const baseUrl=d.config.base_url||'';const effectiveUrl=d.config.effective_base_url||'';console.log('设置缓存启用:',enabled);console.log('设置超时时间:',timeout);console.log('设置域名:',baseUrl);console.log('生效URL:',effectiveUrl);$('cfgCacheEnabled').checked=enabled;$('cfgCacheTimeout').value=timeout;$('cfgCacheBaseUrl').value=baseUrl;if(effectiveUrl){$('cacheEffectiveUrlValue').textContent=effectiveUrl;$('cacheEffectiveUrl').classList.remove('hidden')}else{$('cacheEffectiveUrl').classList.add('hidden')}toggleCacheOptions();console.log('缓存配置加载成功')}else{console.error('缓存配置数据格式错误:',d)}}catch(e){console.error('加载缓存配置失败:',e);showToast('加载缓存配置失败: '+e.message,'error')}},
        loadGenerationTimeout=async()=>{try{console.log('开始加载生成超时配置...');const r=await apiRequest('/api/generation/timeout');if(!r){console.error('API请求失败');return}const d=await r.json();console.log('生成超时配置数据:',d);if(d.success&&d.config){const imageTimeout=d.config.image_timeout||300;const videoTimeout=d.config.video_timeout||1500;console.log('设置图片超时:',imageTimeout);console.log('设置视频超时:',videoTimeout);$('cfgImageTimeout').value=imageTimeout;$('cfgVideoTimeout').value=videoTimeout;console.log('生成超时配置加载成功')}else{console.error('生成超时配置数据格式错误:',d)}}catch(e){console.error('加载生成超时配置失败:',e);showToast('加载生成超时配置失败: '+e.message,'error')}},
        loadLambdaConfig=async()=>{try{const r=await apiRequest('/api/lambda/config');if(!r)return;const d=await r.json();console.log('Lambda配置数据:',d);if(d.success&&d.config){$('cfgLambdaEnabled').checked=!!d.config.lambda_enabled;$('cfgLambdaApiKey').value=d.config.lambda_api_key||'';let urls=d.config.lambda_api_urls||[];console.log('Lambda URLs:',urls);if(!Array.isArray(urls)){urls=[]}if(urls.length===0&&d.config.lambda_api_url){urls=[d.config.lambda_api_url]}renderLambdaUrls(urls);toggleLambdaOptions()}else{console.error('Lambda配置数据格式错误:',d)}}catch(e){console.error('加载Lambda配置失败:',e);showToast('加载Lambda配置失败: '+e.message,'error')}},
        saveCacheConfig=async()=>{const enabled=$('cfgCacheEnabled').checked,timeout=parseInt($('cfgCacheTimeout').value)||7200,baseUrl=$('cfgCacheBaseUrl').value.trim();console.log('保存缓存配置:',{enabled,timeout,baseUrl});if(timeout<60||timeout>86400)return showToast('缓存超时时间必须在 60-86400 秒之间','error');if(baseUrl&&!baseUrl.startsWith('http://')&&!baseUrl.startsWith('https://'))return showToast('域名必须以 http:// 或 https:// 开头','error');try{console.log('保存缓存启用状态...');const r0=await apiRequest('/api/cache/enabled',{method:'POST',body:JSON.stringify({enabled:enabled})});if(!r0){console.error('保存缓存启用状态请求失败');return}const d0=await r0.json();console.log('缓存启用状态保存结果:',d0);if(!d0.success){console.error('保存缓存启用状态失败:',d0);return showToast('保存缓存启用状态失败','error')}console.log('保存超时时间...');const r1=await apiRequest('/api/cache/config',{method:'POST',body:JSON.stringify({timeout:timeout})});if(!r1){console.error('保存超时时间请求失败');return}const d1=await r1.json();console.log('超时时间保存结果:',d1);if(!d1.success){console.error('保存超时时间失败:',d1);return showToast('保存超时时间失败','error')}console.log('保存域名...');const r2=await apiRequest('/api/cache/base-url',{method:'POST',body:JSON.stringify({base_url:baseUrl})});if(!r2){console.error('保存域名请求失败');return}const d2=await r2.json();console.log('域名保存结果:',d2);if(d2.success){showToast('缓存配置保存成功','success');console.log('等待配置文件写入完成...');await new Promise(r=>setTimeout(r,200));console.log('重新加载配置...');await loadCacheConfig()}else{console.error('保存域名失败:',d2);showToast('保存域名失败','error')}}catch(e){console.error('保存失败:',e);showToast('保存失败: '+e.message,'error')}},
        saveGenerationTimeout=async()=>{const imageTimeout=parseInt($('cfgImageTimeout').value)||300,videoTimeout=parseInt($('cfgVideoTimeout').value)||1500;console.log('保存生成超时配置:',{imageTimeout,videoTimeout});if(imageTimeout<60||imageTimeout>3600)return showToast('图片超时时间必须在 60-3600 秒之间','error');if(videoTimeout<60||videoTimeout>7200)return showToast('视频超时时间必须在 60-7200 秒之间','error');try{const r=await apiRequest('/api/generation/timeout',{method:'POST',body:JSON.stringify({image_timeout:imageTimeout,video_timeout:videoTimeout})});if(!r){console.error('保存请求失败');return}const d=await r.json();console.log('保存结果:',d);if(d.success){showToast('生成超时配置保存成功','success');await new Promise(r=>setTimeout(r,200));await loadGenerationTimeout()}else{console.error('保存失败:',d);showToast('保存失败','error')}}catch(e){console.error('保存失败:',e);showToast('保存失败: '+e.message,'error')}},
        saveLambdaConfig=async()=>{const enabled=$('cfgLambdaEnabled').checked,apiKey=$('cfgLambdaApiKey').value.trim(),urls=getLambdaUrls();if(enabled&&urls.length===0)return showToast('请至少添加一个 Lambda 终端地址','error');if(enabled&&!apiKey)return showToast('请输入 Lambda 访问密钥','error');for(const url of urls){if(!url.startsWith('http://')&&!url.startsWith('https://'))return showToast('所有 Lambda 地址必须以 http:// 或 https:// 开头','error')}try{const r=await apiRequest('/api/lambda/config',{method:'POST',body:JSON.stringify({lambda_enabled:enabled,lambda_api_urls:urls.length>0?urls:null,lambda_api_key:apiKey||null})});if(!r)return;const d=await r.json();d.success?showToast('Lambda 配置保存成功','success'):showToast('保存失败','error')}catch(e){showToast('保存失败: '+e.message,'error')}},
        toggleATAutoRefresh=async()=>{try{const enabled=$('atAutoRefreshToggle').checked;const r=await apiRequest('/api/token-refresh/enabled',{method:'POST',body:JSON.stringify({enabled:enabled})});if(!r){$('atAutoRefreshToggle').checked=!enabled;return}const d=await r.json();if(d.success){showToast(enabled?'AT自动刷新已启用':'AT自动刷新已禁用','success')}else{showToast('操作失败: '+(d.detail||'未知错误'),'error');$('atAutoRefreshToggle').checked=!enabled}}catch(e){showToast('操作失败: '+e.message,'error');$('atAutoRefreshToggle').checked=!enabled}},
        loadATAutoRefreshConfig=async()=>{try{const r=await apiRequest('/api/token-refresh/config');if(!r)return;const d=await r.json();if(d.success&&d.config){$('atAutoRefreshToggle').checked=d.config.at_auto_refresh_enabled||false}else{console.error('AT自动刷新配置数据格式错误:',d)}}catch(e){console.error('加载AT自动刷新配置失败:',e)}},
        clamp=(value,min,max)=>Math.min(max,Math.max(min,value)),
        getLogProgress=(l)=>{if(typeof l.progress==='number'){return clamp(Math.round(l.progress),0,100)}if(l.status_code===200){return 100}return null},
        parseLogResponse=(l)=>{if(!l||!l.response_body)return null;try{return JSON.parse(l.response_body)}catch{return null}},
        getLogUrls=(l)=>{const data=parseLogResponse(l);if(!data||typeof data!=='object')return[];if(Array.isArray(data.urls))return data.urls.filter(Boolean);if(typeof data.url==='string')return[data.url];if(data.data&&Array.isArray(data.data)){const urls=data.data.map(item=>item&&item.url).filter(Boolean);if(urls.length)return urls}return[]},
        getLogPermalink=(l)=>{const data=parseLogResponse(l);if(!data||typeof data!=='object')return'';if(typeof data.permalink==='string')return data.permalink;return''},
        formatLogStatus=(l)=>{const code=l.status_code;if(code===-1)return{text:'生成中',className:'bg-blue-50 text-blue-700 border-blue-200'};if(code===200)return{text:'成功',className:'bg-green-50 text-green-700 border-green-200'};if(code===499)return{text:'取消',className:'bg-gray-100 text-gray-700 border-gray-200'};if(code===undefined||code===null)return{text:'-',className:'bg-gray-100 text-gray-700 border-gray-200'};return{text:String(code),className:'bg-red-50 text-red-700 border-red-200'}},
        loadLogs=async()=>{try{const r=await apiRequest('/api/logs?limit=100');if(!r)return;const logs=await r.json();window._logsData=logs;const tb=$('logsTableBody');tb.innerHTML=logs.map((l,i)=>{const status=formatLogStatus(l);const progressValue=getLogProgress(l);const progressText=progressValue!==null?`${progressValue}%`:'-';const progressColor=progressValue===100?'bg-green-600':'bg-blue-600';const progressBar=progressValue!==null?`<div class="h-1.5 w-full rounded bg-muted/60 overflow-hidden"><div class="h-full ${progressColor}" style="width:${progressValue}%"></div></div>`:`<div class="h-1.5 w-full rounded bg-muted/60"></div>`;const durationText=l.duration===-1?'生成中':l.duration.toFixed(2)+' 秒';const timeText=l.created_at?new Date(l.created_at).toLocaleString('zh-CN'):'-';const tokenSub=l.token_username?`@${l.token_username}`:'';const taskIdShort=l.task_id?`${l.task_id.slice(0,8)}...`:'-';const taskStatusText=l.task_status?l.task_status:'';return`<tr class="hover:bg-muted/40"><td class="py-3 px-3"><div class="font-medium">${l.operation}</div><div class="text-xs font-mono text-muted-foreground mt-1">${taskIdShort}</div></td><td class="py-3 px-3"><div class="text-sm ${l.token_email?'text-blue-600':'text-muted-foreground'}">${l.token_email||'未知'}</div>${tokenSub?`<div class="text-xs text-muted-foreground mt-1">${tokenSub}</div>`:''}</td><td class="py-3 px-3"><div class="inline-flex items-center rounded border px-2 py-0.5 text-xs ${status.className}">${status.text}</div>${taskStatusText?`<div class="text-xs text-muted-foreground mt-1">${taskStatusText}</div>`:''}</td><td class="py-3 px-3 min-w-[140px]"><div class="text-xs text-muted-foreground mb-1">${progressText}</div>${progressBar}</td><td class="py-3 px-3 text-xs">${durationText}</td><td class="py-3 px-3 text-xs text-muted-foreground">${timeText}</td><td class="py-3 px-3 text-right"><button onclick="showLogDetail(${i})" class="inline-flex items-center justify-center rounded-md border border-border hover:bg-accent h-7 px-2 text-xs">查看</button></td></tr>`}).join('')}catch(e){console.error('加载日志失败:',e)}},
        showLogDetail=(idx)=>{const l=window._logsData[idx];if(!l)return;let reqBody='',resBody='';try{reqBody=l.request_body?JSON.stringify(JSON.parse(l.request_body),null,2):'-'}catch{reqBody=l.request_body||'-'}try{resBody=l.response_body?JSON.stringify(JSON.parse(l.response_body),null,2):'-'}catch{resBody=l.response_body||'-'}const status=formatLogStatus(l);const progressValue=getLogProgress(l);const progressText=progressValue!==null?`${progressValue}%`:'无';const progressColor=progressValue===100?'bg-green-600':'bg-blue-600';const progressBar=progressValue!==null?`<div class="mt-2 h-2 w-full rounded bg-muted/60 overflow-hidden"><div class="h-full ${progressColor}" style="width:${progressValue}%"></div></div>`:`<div class="mt-2 h-2 w-full rounded bg-muted/60"></div>`;const durationText=l.duration===-1?'生成中':l.duration.toFixed(2)+' 秒';const timeText=l.created_at?new Date(l.created_at).toLocaleString('zh-CN'):'-';const taskStatus=l.task_status||'-';const tokenSub=l.token_username?`@${l.token_username}`:'';const taskId=l.task_id||'-';const urls=getLogUrls(l);const permalink=getLogPermalink(l);const urlSection=urls.length?`<div><p class="text-sm font-medium mb-1">结果URL</p><div class="space-y-1 text-xs">${urls.map(u=>`<a href="${u}" target="_blank" rel="noreferrer" class="text-blue-600 hover:underline break-all">${u}</a>`).join('')}</div></div>`:'';const permalinkSection=permalink?`<div><p class="text-sm font-medium mb-1">Permalink</p><a href="${permalink}" target="_blank" rel="noreferrer" class="text-xs text-blue-600 hover:underline break-all">${permalink}</a></div>`:'';$('logDetailContent').innerHTML=`<div class="space-y-5"><div class="grid gap-4 sm:grid-cols-2"><div><p class="text-sm font-medium mb-1">操作</p><p class="text-sm text-muted-foreground">${l.operation}</p></div><div><p class="text-sm font-medium mb-1">Token</p><p class="text-sm text-muted-foreground">${l.token_email||'未知'}${tokenSub?` <span class="text-xs text-muted-foreground">${tokenSub}</span>`:''}</p></div><div><p class="text-sm font-medium mb-1">状态</p><span class="inline-flex items-center rounded border px-2 py-0.5 text-xs ${status.className}">${status.text}</span></div><div><p class="text-sm font-medium mb-1">进度</p><p class="text-sm text-muted-foreground">${progressText}</p>${progressBar}</div><div><p class="text-sm font-medium mb-1">耗时</p><p class="text-sm text-muted-foreground">${durationText}</p></div><div><p class="text-sm font-medium mb-1">时间</p><p class="text-sm text-muted-foreground">${timeText}</p></div></div><div class="grid gap-4 sm:grid-cols-2 border-t border-border pt-4"><div><p class="text-sm font-medium mb-1">任务ID</p><p class="text-xs font-mono text-muted-foreground break-all">${taskId}</p></div><div><p class="text-sm font-medium mb-1">任务状态</p><p class="text-sm text-muted-foreground">${taskStatus}</p></div></div>${urlSection}${permalinkSection}<div><p class="text-sm font-medium mb-1">请求内容</p><pre class="text-xs bg-muted p-2 rounded overflow-auto max-h-40">${reqBody}</pre></div><div><p class="text-sm font-medium mb-1">响应内容</p><pre class="text-xs bg-muted p-2 rounded overflow-auto max-h-40">${resBody}</pre></div></div>`;$('logDetailModal').classList.remove('hidden')},
        closeLogDetailModal=()=>{$('logDetailModal').classList.add('hidden')},
        refreshLogs=async()=>{await loadLogs()},
        showToast=(m,t='info')=>{const d=document.createElement('div'),bc={success:'bg-green-600',error:'bg-destructive',info:'bg-primary'};d.className=`fixed bottom-4 right-4 ${bc[t]||bc.info} text-white px-4 py-2.5 rounded-lg shadow-lg text-sm font-medium z-50 animate-slide-up`;d.textContent=m;document.body.appendChild(d);setTimeout(()=>{d.style.opacity='0';d.style.transition='opacity .3s';setTimeout(()=>d.parentNode&&document.body.removeChild(d),300)},2000)},
        logout=()=>{if(!confirm('确定要退出登录吗?'))return;localStorage.removeItem('adminToken');location.href='/login'},
        switchTab=t=>{const cap=n=>n.charAt(0).toUpperCase()+n.slice(1);['tokens','settings','logs'].forEach(n=>{const active=n===t;$(`panel${cap(n)}`).classList.toggle('hidden',!active);$(`tab${cap(n)}`).classList.toggle('border-primary',active);$(`tab${cap(n)}`).classList.toggle('text-primary',active);$(`tab${cap(n)}`).classList.toggle('border-transparent',!active);$(`tab${cap(n)}`).classList.toggle('text-muted-foreground',!active)});if(t==='settings'){loadAdminConfig();loadProxyConfig();loadProxyPool();loadWatermarkFreeConfig();loadCloudflareSolverConfig();loadCfState();loadCacheConfig();loadGenerationTimeout();loadLambdaConfig();loadATAutoRefreshConfig()}else if(t==='logs'){loadLogs()}else if(t==='webdav'){loadWebdavConfig();loadWebdavStats();refreshWebdavVideos();refreshUploadLogs()}},
        // WebDAV functions
        toggleWebdavOptions=()=>{const enabled=$('cfgWebdavEnabled').checked;$('webdavOptions').style.display=enabled?'block':'none'},
        loadWebdavConfig=async()=>{try{const r=await apiRequest('/api/webdav/config');if(!r)return;const d=await r.json();if(d.success&&d.config){$('cfgWebdavEnabled').checked=d.config.webdav_enabled||false;$('cfgWebdavUrl').value=d.config.webdav_url||'';$('cfgWebdavUsername').value=d.config.webdav_username||'';$('cfgWebdavPassword').value=d.config.webdav_password||'';$('cfgWebdavUploadPath').value=d.config.webdav_upload_path||'/video';$('cfgAutoDeleteEnabled').checked=d.config.auto_delete_enabled||false;$('cfgAutoDeleteDays').value=d.config.auto_delete_days||30;toggleWebdavOptions()}}catch(e){console.error('加载WebDAV配置失败:',e)}},
        saveWebdavConfig=async()=>{try{const r=await apiRequest('/api/webdav/config',{method:'POST',body:JSON.stringify({webdav_enabled:$('cfgWebdavEnabled').checked,webdav_url:$('cfgWebdavUrl').value,webdav_username:$('cfgWebdavUsername').value,webdav_password:$('cfgWebdavPassword').value,webdav_upload_path:$('cfgWebdavUploadPath').value})});if(!r)return;const d=await r.json();if(d.success){showToast('WebDAV配置保存成功','success')}else{showToast('保存失败: '+(d.message||'未知错误'),'error')}}catch(e){showToast('保存失败: '+e.message,'error')}},
        saveAutoDeleteConfig=async()=>{try{const r=await apiRequest('/api/webdav/config',{method:'POST',body:JSON.stringify({auto_delete_enabled:$('cfgAutoDeleteEnabled').checked,auto_delete_days:parseInt($('cfgAutoDeleteDays').value)||30})});if(!r)return;const d=await r.json();if(d.success){showToast('自动删除配置保存成功','success')}else{showToast('保存失败: '+(d.message||'未知错误'),'error')}}catch(e){showToast('保存失败: '+e.message,'error')}},
        testWebdavConnection=async()=>{$('testWebdavBtnText').textContent='测试中...';$('testWebdavBtnSpinner').classList.remove('hidden');$('webdavTestResult').textContent='';try{const r=await apiRequest('/api/webdav/test',{method:'POST'});if(!r)return;const d=await r.json();if(d.success){$('webdavTestResult').textContent='✓ 连接成功';$('webdavTestResult').className='text-sm text-green-600'}else{$('webdavTestResult').textContent='✗ '+d.message;$('webdavTestResult').className='text-sm text-red-600'}}catch(e){$('webdavTestResult').textContent='✗ '+e.message;$('webdavTestResult').className='text-sm text-red-600'}finally{$('testWebdavBtnText').textContent='测试连接';$('testWebdavBtnSpinner').classList.add('hidden')}},
        loadWebdavStats=async()=>{try{const r=await apiRequest('/api/webdav/videos/stats');if(!r)return;const d=await r.json();if(d.success&&d.stats){$('webdavStatTotal').textContent=d.stats.total||0;$('webdavStatUploaded').textContent=d.stats.uploaded||0;$('webdavStatFailed').textContent=d.stats.failed||0;const sizeMB=((d.stats.total_size||0)/1024/1024).toFixed(2);$('webdavStatSize').textContent=sizeMB+' MB'}}catch(e){console.error('加载WebDAV统计失败:',e)}},
        refreshWebdavVideos=async()=>{try{const r=await apiRequest('/api/webdav/videos?limit=100');if(!r)return;const d=await r.json();if(d.success){const tb=$('webdavVideosTableBody');tb.innerHTML=d.records.map(v=>{const statusClass={'pending':'bg-yellow-50 text-yellow-700','uploading':'bg-blue-50 text-blue-700','uploaded':'bg-green-50 text-green-700','failed':'bg-red-50 text-red-700','deleted':'bg-gray-100 text-gray-700'}[v.status]||'bg-gray-100 text-gray-700';const size=v.file_size?((v.file_size/1024/1024).toFixed(2)+' MB'):'-';return`<tr><td class="py-2.5 px-3 text-xs font-mono">${v.task_id.substring(0,8)}...</td><td class="py-2.5 px-3"><span class="inline-flex items-center rounded px-2 py-0.5 text-xs ${statusClass}">${v.status}</span></td><td class="py-2.5 px-3 text-xs">${size}</td><td class="py-2.5 px-3 text-xs">${v.webdav_path||'-'}</td><td class="py-2.5 px-3 text-xs">${v.uploaded_at?new Date(v.uploaded_at).toLocaleString('zh-CN'):'-'}</td><td class="py-2.5 px-3 text-right">${v.status==='uploaded'?`<button onclick="deleteWebdavVideo(${v.id})" class="inline-flex items-center justify-center rounded-md hover:bg-destructive/10 hover:text-destructive h-7 px-2 text-xs">删除</button>`:''}</td></tr>`}).join('')}}catch(e){console.error('加载视频记录失败:',e)}},
        refreshUploadLogs=async()=>{try{const r=await apiRequest('/api/webdav/logs?limit=100');if(!r)return;const d=await r.json();if(d.success){const tb=$('uploadLogsTableBody');tb.innerHTML=d.logs.map(l=>{const statusClass=l.status==='success'?'bg-green-50 text-green-700':'bg-red-50 text-red-700';return`<tr><td class="py-2.5 px-3">${l.operation}</td><td class="py-2.5 px-3"><span class="inline-flex items-center rounded px-2 py-0.5 text-xs ${statusClass}">${l.status}</span></td><td class="py-2.5 px-3 text-xs">${l.message||'-'}</td><td class="py-2.5 px-3 text-xs">${l.duration?l.duration.toFixed(2)+'s':'-'}</td><td class="py-2.5 px-3 text-xs">${l.created_at?new Date(l.created_at).toLocaleString('zh-CN'):'-'}</td></tr>`}).join('')}}catch(e){console.error('加载上传日志失败:',e)}},
        deleteWebdavVideo=async(id)=>{if(!confirm('确定要删除这个视频吗?'))return;try{const r=await apiRequest(`/api/webdav/videos/${id}`,{method:'DELETE'});if(!r)return;const d=await r.json();if(d.success){showToast('视频删除成功','success');refreshWebdavVideos();loadWebdavStats();refreshUploadLogs()}else{showToast('删除失败: '+(d.message||'未知错误'),'error')}}catch(e){showToast('删除失败: '+e.message,'error')}},
        deleteAllWebdavVideos=async()=>{if(!confirm('确定要删除所有视频吗? 此操作不可恢复!'))return;try{const r=await apiRequest('/api/webdav/videos/delete-all',{method:'POST'});if(!r)return;const d=await r.json();if(d.success){showToast(`删除完成: ${d.deleted}个成功, ${d.failed}个失败`,'success');refreshWebdavVideos();loadWebdavStats();refreshUploadLogs()}else{showToast('删除失败: '+(d.message||'未知错误'),'error')}}catch(e){showToast('删除失败: '+e.message,'error')}},
        triggerAutoDelete=async()=>{if(!confirm('确定要执行自动删除吗?'))return;try{const r=await apiRequest('/api/webdav/videos/auto-delete',{method:'POST'});if(!r)return;const d=await r.json();if(d.success){showToast(`自动删除完成: ${d.deleted}个成功, ${d.failed}个失败`,'success');refreshWebdavVideos();loadWebdavStats();refreshUploadLogs()}else{showToast('执行失败: '+(d.message||'未知错误'),'error')}}catch(e){showToast('执行失败: '+e.message,'error')}},
        clearVideoRecords=async()=>{if(!confirm('确定要清空所有视频记录吗? 此操作不会删除WebDAV上的文件!'))return;try{const r=await apiRequest('/api/webdav/videos/clear-records',{method:'POST'});if(!r)return;const d=await r.json();if(d.success){showToast('视频记录已清空','success');refreshWebdavVideos();loadWebdavStats()}else{showToast('清空失败: '+(d.message||'未知错误'),'error')}}catch(e){showToast('清空失败: '+e.message,'error')}},
        clearUploadLogs=async()=>{if(!confirm('确定要清空所有上传日志吗?'))return;try{const r=await apiRequest('/api/webdav/logs/clear',{method:'POST'});if(!r)return;const d=await r.json();if(d.success){showToast('上传日志已清空','success');refreshUploadLogs()}else{showToast('清空失败: '+(d.message||'未知错误'),'error')}}catch(e){showToast('清空失败: '+e.message,'error')}},
        // 批量操作辅助函数
        openBatchOperationModal=(title)=>{$('batchOperationTitle').textContent=title;$('batchOperationStatus').textContent='准备中...';$('batchOperationProgress').textContent='0/0';$('batchOperationStats').textContent='';$('batchOperationProgressBar').style.width='0%';$('batchOperationLog').innerHTML='';$('batchOperationStopBtn').classList.remove('hidden');$('batchOperationCloseBtn').classList.add('hidden');$('batchOperationModal').classList.remove('hidden');batchOperationRunning=true;batchOperationAbortController=new AbortController()},
        closeBatchOperationModal=()=>{$('batchOperationModal').classList.add('hidden');batchOperationRunning=false;if(batchOperationAbortController){batchOperationAbortController.abort();batchOperationAbortController=null}},
        stopBatchOperation=()=>{batchOperationRunning=false;if(batchOperationAbortController){batchOperationAbortController.abort();batchOperationAbortController=null}$('batchOperationStatus').textContent='已停止';$('batchOperationStopBtn').classList.add('hidden');$('batchOperationCloseBtn').classList.remove('hidden');showToast('批量操作已停止','info')},
        finishBatchOperation=(msg)=>{$('batchOperationStatus').textContent=msg;$('batchOperationStopBtn').classList.add('hidden');$('batchOperationCloseBtn').classList.remove('hidden');batchOperationRunning=false},
        addBatchOperationLog=(msg,type='info')=>{const log=$('batchOperationLog');const color=type==='success'?'text-green-600':type==='error'?'text-red-600':'text-gray-600';log.innerHTML+=`<div class="${color}">${msg}</div>`;log.scrollTop=log.scrollHeight},
        updateBatchOperationProgress=(current,total,success=0,failed=0)=>{$('batchOperationProgress').textContent=`${current}/${total}`;$('batchOperationProgressBar').style.width=`${(current/total)*100}%`;$('batchOperationStats').textContent=`成功: ${success}, 失败: ${failed}`},
        // 批量测试功能
        toggleBatchTestMenu=()=>{const menu=$('batchTestMenu');menu.classList.toggle('hidden');document.addEventListener('click',function closeMenu(e){if(!e.target.closest('#batchTestMenu')&&!e.target.closest('[onclick*="toggleBatchTestMenu"]')){menu.classList.add('hidden');document.removeEventListener('click',closeMenu)}},{once:false})},
        batchTestActiveTokens=async()=>{$('batchTestMenu').classList.add('hidden');const tokens=allTokens.filter(t=>t.is_active);if(tokens.length===0){showToast('没有已启用的账号','info');return}if(!confirm(`将测试 ${tokens.length} 个已启用的账号，401错误将自动禁用，是否继续？`))return;openBatchOperationModal('测试已启用账号');let success=0,failed=0;for(let i=0;i<tokens.length;i++){if(!batchOperationRunning)break;const t=tokens[i];$('batchOperationStatus').textContent=`正在测试: ${t.email}`;updateBatchOperationProgress(i+1,tokens.length,success,failed);try{const r=await apiRequest(`/api/tokens/${t.id}/test`,{method:'POST',signal:batchOperationAbortController?.signal});if(!r){addBatchOperationLog(`[${i+1}/${tokens.length}] ${t.email}: 请求失败`,'error');failed++;continue}const d=await r.json();if(d.success&&d.status==='success'){addBatchOperationLog(`[${i+1}/${tokens.length}] ${t.email}: 有效`,'success');success++}else{addBatchOperationLog(`[${i+1}/${tokens.length}] ${t.email}: ${d.message||'无效'}`,'error');failed++;if(d.message&&d.message.includes('401')){await apiRequest(`/api/tokens/${t.id}/disable`,{method:'POST'})}}}catch(e){if(e.name==='AbortError')break;addBatchOperationLog(`[${i+1}/${tokens.length}] ${t.email}: ${e.message}`,'error');failed++}}await refreshTokens();finishBatchOperation(`完成！成功: ${success}, 失败: ${failed}`)},
        batchTestDisabledTokens=async()=>{$('batchTestMenu').classList.add('hidden');const tokens=allTokens.filter(t=>!t.is_active);if(tokens.length===0){showToast('没有已禁用的账号','info');return}if(!confirm(`将测试 ${tokens.length} 个已禁用的账号，有效账号将自动启用，是否继续？`))return;openBatchOperationModal('测试已禁用账号');let success=0,failed=0;for(let i=0;i<tokens.length;i++){if(!batchOperationRunning)break;const t=tokens[i];$('batchOperationStatus').textContent=`正在测试: ${t.email}`;updateBatchOperationProgress(i+1,tokens.length,success,failed);try{const r=await apiRequest(`/api/tokens/${t.id}/test`,{method:'POST',signal:batchOperationAbortController?.signal});if(!r){addBatchOperationLog(`[${i+1}/${tokens.length}] ${t.email}: 请求失败`,'error');failed++;continue}const d=await r.json();if(d.success&&d.status==='success'){addBatchOperationLog(`[${i+1}/${tokens.length}] ${t.email}: 有效，已启用`,'success');success++;await apiRequest(`/api/tokens/${t.id}/enable`,{method:'POST'})}else{addBatchOperationLog(`[${i+1}/${tokens.length}] ${t.email}: ${d.message||'无效'}`,'error');failed++}}catch(e){if(e.name==='AbortError')break;addBatchOperationLog(`[${i+1}/${tokens.length}] ${t.email}: ${e.message}`,'error');failed++}}await refreshTokens();finishBatchOperation(`完成！成功: ${success}, 失败: ${failed}`)},
        batchTestAllTokens=async()=>{$('batchTestMenu').classList.add('hidden');const tokens=allTokens;if(tokens.length===0){showToast('没有账号','info');return}if(!confirm(`将测试 ${tokens.length} 个账号，401错误自动禁用，有效账号自动启用，是否继续？`))return;openBatchOperationModal('测试所有账号');let success=0,failed=0;for(let i=0;i<tokens.length;i++){if(!batchOperationRunning)break;const t=tokens[i];$('batchOperationStatus').textContent=`正在测试: ${t.email}`;updateBatchOperationProgress(i+1,tokens.length,success,failed);try{const r=await apiRequest(`/api/tokens/${t.id}/test`,{method:'POST',signal:batchOperationAbortController?.signal});if(!r){addBatchOperationLog(`[${i+1}/${tokens.length}] ${t.email}: 请求失败`,'error');failed++;continue}const d=await r.json();if(d.success&&d.status==='success'){addBatchOperationLog(`[${i+1}/${tokens.length}] ${t.email}: 有效`,'success');success++;if(!t.is_active)await apiRequest(`/api/tokens/${t.id}/enable`,{method:'POST'})}else{addBatchOperationLog(`[${i+1}/${tokens.length}] ${t.email}: ${d.message||'无效'}`,'error');failed++;if(t.is_active&&d.message&&d.message.includes('401'))await apiRequest(`/api/tokens/${t.id}/disable`,{method:'POST'})}}catch(e){if(e.name==='AbortError')break;addBatchOperationLog(`[${i+1}/${tokens.length}] ${t.email}: ${e.message}`,'error');failed++}}await refreshTokens();finishBatchOperation(`完成！成功: ${success}, 失败: ${failed}`)},
        // 一键启用/禁用所有账号
        batchEnableAllTokens=async()=>{$('batchTestMenu').classList.add('hidden');const tokens=allTokens.filter(t=>!t.is_active);if(tokens.length===0){showToast('没有已禁用的账号','info');return}if(!confirm(`将启用 ${tokens.length} 个已禁用的账号，是否继续？`))return;openBatchOperationModal('启用所有账号');let success=0,failed=0;for(let i=0;i<tokens.length;i++){if(!batchOperationRunning)break;const t=tokens[i];$('batchOperationStatus').textContent=`正在启用: ${t.email}`;updateBatchOperationProgress(i+1,tokens.length,success,failed);try{const r=await apiRequest(`/api/tokens/${t.id}/enable`,{method:'POST',signal:batchOperationAbortController?.signal});if(!r){addBatchOperationLog(`[${i+1}/${tokens.length}] ${t.email}: 请求失败`,'error');failed++;continue}const d=await r.json();if(d.success){addBatchOperationLog(`[${i+1}/${tokens.length}] ${t.email}: 已启用`,'success');success++}else{addBatchOperationLog(`[${i+1}/${tokens.length}] ${t.email}: ${d.message||'失败'}`,'error');failed++}}catch(e){if(e.name==='AbortError')break;addBatchOperationLog(`[${i+1}/${tokens.length}] ${t.email}: ${e.message}`,'error');failed++}}await refreshTokens();finishBatchOperation(`完成！成功: ${success}, 失败: ${failed}`)},
        batchDisableAllTokens=async()=>{$('batchTestMenu').classList.add('hidden');const tokens=allTokens.filter(t=>t.is_active);if(tokens.length===0){showToast('没有已启用的账号','info');return}if(!confirm(`将禁用 ${tokens.length} 个已启用的账号，是否继续？`))return;openBatchOperationModal('禁用所有账号');let success=0,failed=0;for(let i=0;i<tokens.length;i++){if(!batchOperationRunning)break;const t=tokens[i];$('batchOperationStatus').textContent=`正在禁用: ${t.email}`;updateBatchOperationProgress(i+1,tokens.length,success,failed);try{const r=await apiRequest(`/api/tokens/${t.id}/disable`,{method:'POST',signal:batchOperationAbortController?.signal});if(!r){addBatchOperationLog(`[${i+1}/${tokens.length}] ${t.email}: 请求失败`,'error');failed++;continue}const d=await r.json();if(d.success){addBatchOperationLog(`[${i+1}/${tokens.length}] ${t.email}: 已禁用`,'success');success++}else{addBatchOperationLog(`[${i+1}/${tokens.length}] ${t.email}: ${d.message||'失败'}`,'error');failed++}}catch(e){if(e.name==='AbortError')break;addBatchOperationLog(`[${i+1}/${tokens.length}] ${t.email}: ${e.message}`,'error');failed++}}await refreshTokens();finishBatchOperation(`完成！成功: ${success}, 失败: ${failed}`)},
        batchDeleteDisabledTokens=async()=>{$('batchTestMenu').classList.add('hidden');const tokens=allTokens.filter(t=>!t.is_active);if(tokens.length===0){showToast('没有已禁用的账号','info');return}if(!confirm(`将永久删除 ${tokens.length} 个已禁用的账号，此操作不可恢复，是否继续？`))return;openBatchOperationModal('删除禁用账号');let success=0,failed=0;for(let i=0;i<tokens.length;i++){if(!batchOperationRunning)break;const t=tokens[i];$('batchOperationStatus').textContent=`正在删除: ${t.email}`;updateBatchOperationProgress(i+1,tokens.length,success,failed);try{const r=await apiRequest(`/api/tokens/${t.id}`,{method:'DELETE',signal:batchOperationAbortController?.signal});if(!r){addBatchOperationLog(`[${i+1}/${tokens.length}] ${t.email}: 请求失败`,'error');failed++;continue}const d=await r.json();if(d.success){addBatchOperationLog(`[${i+1}/${tokens.length}] ${t.email}: 已删除`,'success');success++}else{addBatchOperationLog(`[${i+1}/${tokens.length}] ${t.email}: ${d.message||'失败'}`,'error');failed++}}catch(e){if(e.name==='AbortError')break;addBatchOperationLog(`[${i+1}/${tokens.length}] ${t.email}: ${e.message}`,'error');failed++}}await refreshTokens();finishBatchOperation(`完成！成功: ${success}, 失败: ${failed}`)};
        // 在线测试相关变量和函数
        let videoMode='normal',videoOrientation='landscape',videoDuration='10',imageSize='1024x1024',videoRefBase64=null,imageRefBase64=null,isGenerating=false;
        switchTestTab=t=>{['video','image'].forEach(n=>{const active=n===t;$(`testPanel${n.charAt(0).toUpperCase()+n.slice(1)}`).classList.toggle('hidden',!active);$(`testTab${n.charAt(0).toUpperCase()+n.slice(1)}`).classList.toggle('border-primary',active);$(`testTab${n.charAt(0).toUpperCase()+n.slice(1)}`).classList.toggle('border-transparent',!active)})},
        setVideoMode=m=>{videoMode=m;['normal','remix','storyboard'].forEach(n=>{const btn=$('mode'+n.charAt(0).toUpperCase()+n.slice(1));if(n===m){btn.classList.add('border-primary','bg-primary','text-primary-foreground');btn.classList.remove('border-input')}else{btn.classList.remove('border-primary','bg-primary','text-primary-foreground');btn.classList.add('border-input')}});$('remixIdSection').classList.toggle('hidden',m!=='remix')},
        setOrientation=o=>{videoOrientation=o;['landscape','portrait'].forEach(n=>{const btn=$('orient'+n.charAt(0).toUpperCase()+n.slice(1));if(n===o){btn.classList.add('border-primary','bg-primary','text-primary-foreground');btn.classList.remove('border-input')}else{btn.classList.remove('border-primary','bg-primary','text-primary-foreground');btn.classList.add('border-input')}});const p=$('videoPreviewArea');p.classList.remove('aspect-video','aspect-portrait');p.classList.add(o==='portrait'?'aspect-portrait':'aspect-video')},
        setDuration=d=>{videoDuration=d;['10','15','25'].forEach(n=>{const btn=$('dur'+n);if(n===d){btn.classList.add('border-primary','bg-primary','text-primary-foreground');btn.classList.remove('border-input')}else{btn.classList.remove('border-primary','bg-primary','text-primary-foreground');btn.classList.add('border-input')}})},
        setImageSize=s=>{imageSize=s;const m={'1024x1024':'1x1','1792x1024':'3x2','1024x1792':'2x3','1536x1024':'16x9'};Object.keys(m).forEach(k=>{const btn=$('size'+m[k].replace(':','x'));if(k===s){btn.classList.add('border-primary','bg-primary','text-primary-foreground');btn.classList.remove('border-input')}else{btn.classList.remove('border-primary','bg-primary','text-primary-foreground');btn.classList.add('border-input')}});const p=$('imagePreviewArea');p.classList.remove('aspect-square','aspect-video','aspect-portrait');if(s==='1024x1024')p.classList.add('aspect-square');else if(s==='1024x1792')p.classList.add('aspect-portrait');else p.classList.add('aspect-video')},
        handleVideoRefUpload=e=>{const f=e.target.files[0];if(!f)return;const r=new FileReader();r.onload=ev=>{videoRefBase64=ev.target.result.split(',')[1];$('videoRefImg').src=ev.target.result;$('videoRefPreview').classList.remove('hidden');$('videoRefPlaceholder').classList.add('hidden')};r.readAsDataURL(f)},
        clearVideoRef=e=>{e.stopPropagation();videoRefBase64=null;$('videoRefInput').value='';$('videoRefPreview').classList.add('hidden');$('videoRefPlaceholder').classList.remove('hidden')},
        handleImageRefUpload=e=>{const f=e.target.files[0];if(!f)return;const r=new FileReader();r.onload=ev=>{imageRefBase64=ev.target.result.split(',')[1];$('imageRefImg').src=ev.target.result;$('imageRefPreview').classList.remove('hidden');$('imageRefPlaceholder').classList.add('hidden')};r.readAsDataURL(f)},
        clearImageRef=e=>{e.stopPropagation();imageRefBase64=null;$('imageRefInput').value='';$('imageRefPreview').classList.add('hidden');$('imageRefPlaceholder').classList.remove('hidden')},
        getTestApiKey=()=>{const k=localStorage.getItem('test_api_key')||prompt('请输入 API Key:');if(k)localStorage.setItem('test_api_key',k);return k},
        generateVideo=async()=>{if(isGenerating)return;const prompt=$('videoPrompt').value.trim();if(!prompt){showToast('请输入提示词','error');return}const apiKey=getTestApiKey();if(!apiKey){showToast('需要 API Key','error');return}isGenerating=true;const btn=$('videoGenBtn');btn.disabled=true;btn.innerHTML='<svg class="animate-spin h-4 w-4 mr-2" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4" fill="none"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"></path></svg>生成中...';$('videoStatus').textContent='正在生成视频，请稍候...';$('videoPreviewArea').innerHTML='<div class="flex flex-col items-center justify-center h-full"><svg class="animate-spin h-8 w-8 text-primary mb-2" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4" fill="none"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"></path></svg><p class="text-muted-foreground">生成中...</p></div>';try{const body={prompt,seconds:videoDuration,orientation:videoOrientation,style_id:$('videoStyle').value||undefined};if(videoRefBase64)body.input_image=videoRefBase64;if(videoMode==='remix')body.remix_target_id=$('remixTargetId').value.trim();const r=await fetch('/v1/videos',{method:'POST',headers:{'Content-Type':'application/json','Authorization':'Bearer '+apiKey},body:JSON.stringify(body),signal:AbortSignal.timeout(600000)});const d=await r.json();if(d.error)throw new Error(d.error.message||'生成失败');if(d.data&&d.data[0]&&d.data[0].url){const url=d.data[0].url;$('videoPreviewArea').innerHTML=`<video src="${url}" controls class="w-full h-full rounded-lg object-contain" autoplay></video>`;$('videoStatus').innerHTML=`<a href="${url}" target="_blank" class="text-primary hover:underline">下载视频</a>`;showToast('视频生成成功！','success')}else throw new Error('未获取到视频URL')}catch(e){$('videoPreviewArea').innerHTML='<p class="text-destructive">生成失败</p>';$('videoStatus').textContent=e.message;showToast('生成失败: '+e.message,'error')}finally{isGenerating=false;btn.disabled=false;btn.innerHTML='<svg class="h-4 w-4 mr-2" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="5 3 19 12 5 21 5 3"/></svg>开始生成'}},
        generateImage=async()=>{if(isGenerating)return;const prompt=$('imagePrompt').value.trim();if(!prompt){showToast('请输入提示词','error');return}const apiKey=getTestApiKey();if(!apiKey){showToast('需要 API Key','error');return}isGenerating=true;const btn=$('imageGenBtn');btn.disabled=true;btn.innerHTML='<svg class="animate-spin h-4 w-4 mr-2" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4" fill="none"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"></path></svg>生成中...';$('imageStatus').textContent='正在生成图片，请稍候...';$('imagePreviewArea').innerHTML='<div class="flex flex-col items-center justify-center h-full"><svg class="animate-spin h-8 w-8 text-primary mb-2" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4" fill="none"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"></path></svg><p class="text-muted-foreground">生成中...</p></div>';try{const body={prompt,size:imageSize};if(imageRefBase64)body.input_image=imageRefBase64;const r=await fetch('/v1/images/generations',{method:'POST',headers:{'Content-Type':'application/json','Authorization':'Bearer '+apiKey},body:JSON.stringify(body),signal:AbortSignal.timeout(300000)});const d=await r.json();if(d.error)throw new Error(d.error.message||'生成失败');if(d.data&&d.data[0]&&d.data[0].url){const url=d.data[0].url;$('imagePreviewArea').innerHTML=`<img src="${url}" class="w-full h-full rounded-lg object-contain" />`;$('imageStatus').innerHTML=`<a href="${url}" target="_blank" class="text-primary hover:underline">下载图片</a>`;showToast('图片生成成功！','success')}else throw new Error('未获取到图片URL')}catch(e){$('imagePreviewArea').innerHTML='<p class="text-destructive">生成失败</p>';$('imageStatus').textContent=e.message;showToast('生成失败: '+e.message,'error')}finally{isGenerating=false;btn.disabled=false;btn.innerHTML='<svg class="h-4 w-4 mr-2" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"/><circle cx="8.5" cy="8.5" r="1.5"/><polyline points="21 15 16 10 5 21"/></svg>开始生成'}};
        window.addEventListener('DOMContentLoaded',()=>{checkAuth();refreshTokens();loadATAutoRefreshConfig()});
        window.addEventListener('beforeunload',(e)=>{if(batchOperationRunning){stopBatchOperation();e.preventDefault();e.returnValue='批量操作正在进行中，确定要离开吗？'}});
        window.addEventListener('unload',()=>{if(batchOperationRunning)stopBatchOperation()});
    </script>
</body>
</html>
